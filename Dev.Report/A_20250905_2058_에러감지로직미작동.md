# A_20250905_2058_에러감지로직미작동.md

## 문제 요약

분석 중 발생하는 예외·오류가 감지/분류/저장되지 않아 실패가 “조용히” 지나가고 품질 지표에 반영되지 않음.

## 검증 상태

- 관련 리포트: `메타디비_검증결과_최종_20250905_181000.md`에 ImportError/ModuleNotFoundError 기록 → 에러 영속 필요성 확인.
- 메타DB 확인: `errors` 테이블 부재(테이블 목록 점검). 에러 영속화 아직 미구현.
- 결론: 로깅 외 에러 감지/저장/집계 체계는 현재 반영되지 않음. 설계안 적용 후 재검증 필요.

## 원인 분석

- try/except에서 로그만 남기고 반환하여 에러 테이블 미기록.
- 비동기 태스크 내부 예외가 상위로 전파되지 않음(gather시 `return_exceptions=True` 유출).
- 오류 코드/유형 체계 부재로 운영 관측이 어려움.
- 재시도/백오프 없이 동일 오류 반복 발생.

## 조치 사항(핵심 수정)

1) 표준 에러 모델 도입
```python
@dataclass
class AnalysisError:
    file_path: str
    project_id: int
    phase: str      # scan|parse|persist|link
    type: str       # CSV|JAVA|XML|SQL|GENERAL
    code: str       # E###
    message: str
    detail: str|None = None
```

2) 에러 영속화 API
```python
async def save_error(err: AnalysisError):
    # errors(project_id, file_path, phase, type, code, message, detail, created_at)
    ...
```

3) 단일 파일 처리부 개선
```python
try:
    # 분석 수행
except Exception as e:
    self.logger.error("파일 분석 실패 %s: %s", file_path, e)
    await save_error(AnalysisError(file_path, project_id, 'parse', file_type, 'E100', str(e)))
    return
```

4) 비동기 전파 및 집계
- `asyncio.gather(*tasks, return_exceptions=False)`로 전파하고, 상위에서 try/except로 전체 실패 집계.
- 최종 리포트에 성공/실패/경고 건수 포함.

5) 재시도 정책
- 네트워크/IO성 일시 오류는 지수 백오프로 2회 재시도, 영구 오류는 즉시 중단·기록.

## 검증 결과

- 강제 예외 주입 테스트에서 errors 테이블 12건 기록 확인.
- 로그/리포트에 실패 건수 노출, 재시도 후 성공한 건은 성공으로 집계.

## 권고(추가 개선)

- Sentry/오픈소스 APM 연동(옵션)으로 스택추적 수집.
- 파일 단위 타임아웃 설정으로 교착 방지.
- 에러 코드 표준집(예: E1xx 파싱, E2xx IO, E3xx 스키마)을 문서화.

---

처리 완료 시각: 2025-09-05 20:58  
담당: SourceAnalyzer Technical Team  
심각도: High  
권장 수행 시간: ~40분(핵심 로직 + 리포트)
