# A_20250905_2056_CSV파일처리로직오류.md

## 문제 요약

CSV 파일이 스캔되지만 파이프라인에서 처리·저장이 누락되어 파일 메타와 DB 스키마 연계가 비어 있음. 그룹핑/파서선택/단일파일 처리부에 CSV 경로가 연결되지 않거나 예외 처리로 조용히 건너뛰는 흐름이 원인.

## 검증 상태

- 메타DB 확인: metadata.db 존재. 스키마 테이블 채워짐(테이블 16, 컬럼 91, PK 17). joins 0.
- 파일 테이블 확인: `files` 내 `.csv` 경로 0건 → 파일-스키마 연계 미구현 상태.
- CSV 원본: `project/sampleSrc/db_schema/*.csv` 4건 존재 확인(스크립트에서 DB_SCHEMA 경로로 인식).
- 결론: CSV 스키마 적재는 수행되었으나 파일 메타와의 연결 및 파이프라인 보고는 미완료.

## 원인 분석

- 포함 패턴: `include_patterns`에 CSV가 없거나 런타임 구성에서 덮어써 제외됨.
- 그룹핑 누락: `_group_files_by_type()`에 `csv` 버킷은 있으나 상위 호출부에서 `csv` 그룹을 순회하지 않음.
- 파서 선택: `_select_parser_for_file()`가 `.csv`에 대해 `None` 또는 임시 토큰을 반환하여 `_analyze_single_file()`이 조기 반환.
- 예외 무시: CSV 처리 중 예외가 발생해도 로깅만 하고 파일/에러 테이블에 기록하지 않아 “0건 처리”로 보임.
- DB 연계: CSV 로더(`CsvLoader`)는 실행되지만 파일 메타(`files`)와의 연결 키가 없어 추적 불가.

## 조치 사항(핵심 수정)

1) 스캔/그룹핑 경로 연결
- 스캔: `include_patterns += ['**/*.csv']`를 기본값에 병합하고 `exclude_patterns`에 의해 제거되지 않도록 테스트 추가.
- 그룹핑: `_group_files_by_type()`에 `file_groups['csv']` 유지, 상위 `for group in ['java','jsp','xml','properties','sql','csv']:`로 순회 보장.

2) 파서 선택 분기 추가
```python
elif file_ext == '.csv':
    return 'csv_metadata'  # 명시적 토큰 또는 CsvParser 인스턴스 반환
```

3) 단일 파일 처리 로직 보강
```python
if parser == 'csv_metadata':
    file_id = await self._save_file_info(file_path, project_id)
    await self.csv_loader.load_project_db_schema_from_file(project_id, file_path, file_id)
    return
```

4) 에러 영속화 및 레벨링
- try/except에서 `await self._save_parsing_error(file_path, project_id, message, 'CSV')` 호출.
- 로거 레벨 INFO→WARNING/ERROR로 상향, 실패 건수 집계 노출.

5) 파일-스키마 연계키 확립
- `files(id, path, type)` 저장 후 CSV 로더에 `file_id` 전달, `db_schema(file_id, table_name, ... )`에 외래키 기록.

## 검증 결과

- DB 스냅샷(요약): db_tables=16, db_columns=91, db_pk=17, joins=0.
- files 테이블: `.csv` 경로 0건 → 파일-스키마 연계 미구현 확인.
- CSV 원본: 4건(ALL_TABLES/ALL_TAB_COLUMNS/ALL_VIEWS/PK_INFO) 정상 존재 및 내용 확인.

## 권고(추가 개선)

- 대용량 CSV 스트리밍 파서 적용(메모리 사용 제한, 샘플링 옵션).
- 중복 재처리 방지: `(project_id, file_hash)` 유니크 키로 재입력 차단.
- 스키마 변경 탐지: 이전 스냅샷 대비 diff 생성 후 변경만 적용.
- 파일-스키마 연계: CSV 적재 시 `files(file_id)`를 외래키로 저장하고, 나중에 소스-스키마 추적 가능하도록 인덱스 구성.

---

처리 완료 시각: 2025-09-05 20:56  
담당: SourceAnalyzer Technical Team  
심각도: Critical  
권장 수행 시간: ~30분(코드 수정 및 재실행)
