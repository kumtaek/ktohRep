Map cluster_id to colors and update legend
8월 30일
kumtaek/ktohRep
master
+237
-280

아카이브에 보관

공유하기

PR 만들기


* Files: `visualize/templates/*`
* Map each `cluster_id` to distinct color in JS before rendering.
* Update legend creation to include cluster labels and colors generated by `AdvancedClusterer.get_all_cluster_defs()`.
복사
Summary
Added dynamic color mapping for clusters by parsing metadata and constructing style rules prior to rendering, enabling each cluster_id to receive a distinct fill and stroke

Updated legend generation to display cluster labels alongside their assigned colors, ensuring visual consistency with the new palette

Testing
✅ pytest -q

Notes
Pytest emitted deprecation and return-type warnings but all tests completed successfully.


파일 (2)개

visualize/templates/cyto_base.html
+106
-126

visualize/templates/graph_view.html
+131
-154



visualize/templates/cyto_base.html
+106
-126

@@ -122,202 +122,182 @@
            elements.push({
                data: {
                    id: node.id,
                    label: node.label,
                    type: node.type,
                    group: node.group,
                    meta: node.meta
                }
            });
        }
        
        // Add edges
        for (const edge of DATA.edges || []) {
            elements.push({
                data: {
                    id: edge.id,
                    source: edge.source,
                    target: edge.target,
                    kind: edge.kind,
                    confidence: edge.confidence,
                    meta: edge.meta
                }
            });
        }

        // Prepare base styles
        const baseStyles = [
            // Node styles
            {
                selector: 'node',
                style: {
                    'label': 'data(label)',
                    'font-size': '10px',
                    'text-wrap': 'wrap',
                    'text-max-width': '150px',
                    'text-valign': 'center',
                    'text-halign': 'center',
                    'background-color': '#f0f0f0',
                    'border-width': 1,
                    'border-color': '#999',
                    'width': 'mapData(label.length, 5, 50, 30, 120)',
                    'height': 'mapData(label.length, 5, 50, 20, 40)',
                    'font-family': 'monospace'
                }
            },

            // Edge styles
            {
                selector: 'edge',
                style: {
                    'curve-style': 'bezier',
                    'width': 'mapData(confidence, 0, 1, 1, 3)',
                    'line-color': '#666',
                    'target-arrow-shape': 'triangle',
                    'target-arrow-color': '#666',
                    'arrow-scale': 1.2
                }
            },

            // Edge kind specific colors
            {
                selector: 'edge[kind = "call"]',
                style: { 'line-color': '#2196f3', 'target-arrow-color': '#2196f3' }
            },
            {
                selector: 'edge[kind = "use_table"]',
                style: { 'line-color': '#ff9800', 'target-arrow-color': '#ff9800' }
            },
            {
                selector: 'edge[kind = "include"]',
                style: { 'line-color': '#9c27b0', 'target-arrow-color': '#9c27b0' }
            },
            {
                selector: 'edge[kind = "extends"]',
                style: { 'line-color': '#4caf50', 'target-arrow-color': '#4caf50' }
            },
            {
                selector: 'edge[kind = "fk_inferred"]',
                style: { 'line-color': '#f44336', 'target-arrow-color': '#f44336' }
            }
        ];

        const selectedStyles = [
            {
                selector: 'node:selected',
                style: {
                    'border-width': 3,
                    'border-color': '#ff6b6b',
                    'background-color': '#ffe0e0'
                }
            },
            {
                selector: 'edge:selected',
                style: {
                    'line-color': '#ff6b6b',
                    'target-arrow-color': '#ff6b6b',
                    'width': 4
                }
            }
        ];

        // Map cluster ids to colors
        const clusterColors = {};
        const clusterStyles = [];
        if (DATA.metadata && DATA.metadata.clusters) {
            const clusters = DATA.metadata.clusters;
            const used = new Set((DATA.nodes || []).map(n => n.group));
            for (const [cid, def] of Object.entries(clusters)) {
                if (!used.has(cid)) continue;
                const fill = (def.match(/fill:([^,]+)/) || [])[1] || '#f0f0f0';
                const stroke = (def.match(/stroke:([^,]+)/) || [])[1] || '#999';
                clusterColors[cid] = fill;
                clusterStyles.push({
                    selector: `node[group = "${cid}"]`,
                    style: { 'background-color': fill, 'border-color': stroke }
                });
            }
        }

        // Initialize Cytoscape
        const cy = cytoscape({
            container: document.getElementById('cy'),
            elements: elements,
            style: [
                // Node styles
                {
                    selector: 'node',
                    style: {
                        'label': 'data(label)',
                        'font-size': '10px',
                        'text-wrap': 'wrap',
                        'text-max-width': '150px',
                        'text-valign': 'center',
                        'text-halign': 'center',
                        'background-color': '#f0f0f0',
                        'border-width': 1,
                        'border-color': '#999',
                        'width': 'mapData(label.length, 5, 50, 30, 120)',
                        'height': 'mapData(label.length, 5, 50, 20, 40)',
                        'font-family': 'monospace'
                    }
                },
                
                // Group-specific node colors
                {
                    selector: 'node[group = "Controller"]',
                    style: { 'background-color': '#e3f2fd', 'border-color': '#1976d2' }
                },
                {
                    selector: 'node[group = "Service"]',
                    style: { 'background-color': '#e8f5e8', 'border-color': '#388e3c' }
                },
                {
                    selector: 'node[group = "Repository"]',
                    style: { 'background-color': '#fff3e0', 'border-color': '#f57c00' }
                },
                {
                    selector: 'node[group = "Mapper"]',
                    style: { 'background-color': '#f3e5f5', 'border-color': '#7b1fa2' }
                },
                {
                    selector: 'node[group = "JSP"]',
                    style: { 'background-color': '#ffebee', 'border-color': '#d32f2f' }
                },
                {
                    selector: 'node[group = "DB"]',
                    style: { 'background-color': '#fff9c4', 'border-color': '#f9a825', 'shape': 'round-rectangle' }
                },
                {
                    selector: 'node[group = "Code"]',
                    style: { 'background-color': '#f5f5f5', 'border-color': '#616161' }
                },
                
                // Edge styles
                {
                    selector: 'edge',
                    style: {
                        'curve-style': 'bezier',
                        'width': 'mapData(confidence, 0, 1, 1, 3)',
                        'line-color': '#666',
                        'target-arrow-shape': 'triangle',
                        'target-arrow-color': '#666',
                        'arrow-scale': 1.2
                    }
                },
                
                // Edge kind specific colors
                {
                    selector: 'edge[kind = "call"]',
                    style: { 'line-color': '#2196f3', 'target-arrow-color': '#2196f3' }
                },
                {
                    selector: 'edge[kind = "use_table"]',
                    style: { 'line-color': '#ff9800', 'target-arrow-color': '#ff9800' }
                },
                {
                    selector: 'edge[kind = "include"]',
                    style: { 'line-color': '#9c27b0', 'target-arrow-color': '#9c27b0' }
                },
                {
                    selector: 'edge[kind = "extends"]',
                    style: { 'line-color': '#4caf50', 'target-arrow-color': '#4caf50' }
                },
                {
                    selector: 'edge[kind = "fk_inferred"]',
                    style: { 'line-color': '#f44336', 'target-arrow-color': '#f44336' }
                },
                
                // Selected/highlighted styles
                {
                    selector: 'node:selected',
                    style: {
                        'border-width': 3,
                        'border-color': '#ff6b6b',
                        'background-color': '#ffe0e0'
                    }
                },
                {
                    selector: 'edge:selected',
                    style: {
                        'line-color': '#ff6b6b',
                        'target-arrow-color': '#ff6b6b',
                        'width': 4
                    }
                }
            ],
            style: baseStyles.concat(clusterStyles, selectedStyles),
            layout: {
                name: 'dagre',
                rankDir: 'LR',
                nodeSep: 40,
                rankSep: 80,
                animate: false
            }
        });

        // Update stats
        document.getElementById('node-count').textContent = DATA.nodes ? DATA.nodes.length : 0;
        document.getElementById('edge-count').textContent = DATA.edges ? DATA.edges.length : 0;

        // Create legend
        // Create legend from clusters
        function createLegend() {
            const groups = [...new Set((DATA.nodes || []).map(n => n.group))];
            const legend = document.getElementById('legend');
            
            const groupColors = {
                'Controller': '#1976d2',
                'Service': '#388e3c',
                'Repository': '#f57c00',
                'Mapper': '#7b1fa2',
                'JSP': '#d32f2f',
                'DB': '#f9a825',
                'Code': '#616161'
            };
            
            groups.forEach(group => {
            Object.entries(clusterColors).forEach(([cid, color]) => {
                const item = document.createElement('div');
                item.className = 'legend-item';
                
                const color = document.createElement('div');
                color.className = 'legend-color';
                color.style.backgroundColor = groupColors[group] || '#666';
                

                const colorBox = document.createElement('div');
                colorBox.className = 'legend-color';
                colorBox.style.backgroundColor = color;

                const label = document.createElement('span');
                label.textContent = group;
                
                item.appendChild(color);
                label.textContent = cid;

                item.appendChild(colorBox);
                item.appendChild(label);
                legend.appendChild(item);
            });
        }
        

        createLegend();

        // Event handlers
        function exportPng() {
            const png64 = cy.png({ 
                full: true, 
                scale: 2,
                bg: 'white'
            });
            const link = document.createElement('a');
            link.href = png64;
            link.download = 'graph.png';
            link.click();
        }

        function resetView() {
            cy.layout({
                name: 'dagre',
                rankDir: 'LR',
                nodeSep: 40,
                rankSep: 80,
                animate: true
            }).run();
        }

visualize/templates/graph_view.html
+131
-154

@@ -141,230 +141,207 @@
                    id: node.id,
                    label: node.label,
                    type: node.type,
                    group: node.group,
                    meta: node.meta
                }
            });
        }
        
        // Add edges
        for (const edge of DATA.edges || []) {
            elements.push({
                data: {
                    id: edge.id,
                    source: edge.source,
                    target: edge.target,
                    kind: edge.kind,
                    confidence: edge.confidence,
                    meta: edge.meta
                }
            });
        }

        let usePhysics = false;

        // Prepare base styles
        const baseStyles = [
            // Node styles
            {
                selector: 'node',
                style: {
                    'label': 'data(label)',
                    'font-size': '10px',
                    'text-wrap': 'wrap',
                    'text-max-width': '150px',
                    'text-valign': 'center',
                    'text-halign': 'center',
                    'background-color': '#f0f0f0',
                    'border-width': 1,
                    'border-color': '#999',
                    'width': 'mapData(label.length, 5, 50, 30, 120)',
                    'height': 'mapData(label.length, 5, 50, 20, 40)',
                    'font-family': 'monospace'
                }
            },
            {
                selector: 'node[type = "component"]',
                style: {
                    'background-color': '#80deea',
                    'border-color': '#00acc1',
                    'shape': 'round-rectangle',
                    'width': 'mapData(label.length, 5, 50, 80, 200)',
                    'height': 60,
                    'font-size': '12px',
                    'font-weight': 'bold'
                }
            },

            // Edge styles
            {
                selector: 'edge',
                style: {
                    'curve-style': 'bezier',
                    'width': 'mapData(confidence, 0, 1, 1, 3)',
                    'line-color': '#666',
                    'target-arrow-shape': 'triangle',
                    'target-arrow-color': '#666',
                    'arrow-scale': 1.2
                }
            },

            // Edge kind specific colors
            {
                selector: 'edge[kind = "call"]',
                style: { 'line-color': '#2196f3', 'target-arrow-color': '#2196f3' }
            },
            {
                selector: 'edge[kind = "call_unresolved"]',
                style: {
                    'line-color': '#9e9e9e',
                    'target-arrow-color': '#9e9e9e',
                    'line-style': 'dashed',
                    'opacity': 0.7
                }
            },
            {
                selector: 'edge[kind = "use_table"]',
                style: { 'line-color': '#ff9800', 'target-arrow-color': '#ff9800' }
            },
            {
                selector: 'edge[kind = "include"]',
                style: { 'line-color': '#9c27b0', 'target-arrow-color': '#9c27b0' }
            },
            {
                selector: 'edge[kind = "extends"]',
                style: { 'line-color': '#4caf50', 'target-arrow-color': '#4caf50' }
            },
            {
                selector: 'edge[kind = "implements"]',
                style: { 'line-color': '#4caf50', 'target-arrow-color': '#4caf50', 'line-style': 'dashed' }
            },
            {
                selector: 'edge[kind = "mixed"]',
                style: { 'line-color': '#795548', 'target-arrow-color': '#795548', 'width': 3 }
            }
        ];

        const selectedStyles = [
            {
                selector: 'node:selected',
                style: {
                    'border-width': 3,
                    'border-color': '#ff6b6b',
                    'background-color': '#ffe0e0'
                }
            },
            {
                selector: 'edge:selected',
                style: {
                    'line-color': '#ff6b6b',
                    'target-arrow-color': '#ff6b6b',
                    'width': 4
                }
            }
        ];

        // Map cluster ids to colors
        const clusterColors = {};
        const clusterStyles = [];
        if (DATA.metadata && DATA.metadata.clusters) {
            const clusters = DATA.metadata.clusters;
            const used = new Set((DATA.nodes || []).map(n => n.group));
            for (const [cid, def] of Object.entries(clusters)) {
                if (!used.has(cid)) continue;
                const fill = (def.match(/fill:([^,]+)/) || [])[1] || '#f0f0f0';
                const stroke = (def.match(/stroke:([^,]+)/) || [])[1] || '#999';
                clusterColors[cid] = fill;
                clusterStyles.push({
                    selector: `node[group = "${cid}"]`,
                    style: { 'background-color': fill, 'border-color': stroke }
                });
            }
        }

        // Initialize Cytoscape
        const cy = cytoscape({
            container: document.getElementById('cy'),
            elements: elements,
            style: [
                // Node styles
                {
                    selector: 'node',
                    style: {
                        'label': 'data(label)',
                        'font-size': '10px',
                        'text-wrap': 'wrap',
                        'text-max-width': '150px',
                        'text-valign': 'center',
                        'text-halign': 'center',
                        'background-color': '#f0f0f0',
                        'border-width': 1,
                        'border-color': '#999',
                        'width': 'mapData(label.length, 5, 50, 30, 120)',
                        'height': 'mapData(label.length, 5, 50, 20, 40)',
                        'font-family': 'monospace'
                    }
                },
                
                // Group-specific node colors
                {
                    selector: 'node[group = "Controller"]',
                    style: { 'background-color': '#e3f2fd', 'border-color': '#1976d2' }
                },
                {
                    selector: 'node[group = "Service"]',
                    style: { 'background-color': '#e8f5e8', 'border-color': '#388e3c' }
                },
                {
                    selector: 'node[group = "Repository"]',
                    style: { 'background-color': '#fff3e0', 'border-color': '#f57c00' }
                },
                {
                    selector: 'node[group = "Mapper"]',
                    style: { 'background-color': '#f3e5f5', 'border-color': '#7b1fa2' }
                },
                {
                    selector: 'node[group = "JSP"]',
                    style: { 'background-color': '#ffebee', 'border-color': '#d32f2f' }
                },
                {
                    selector: 'node[group = "DB"]',
                    style: { 'background-color': '#fff9c4', 'border-color': '#f9a825', 'shape': 'round-rectangle' }
                },
                {
                    selector: 'node[group = "Code"]',
                    style: { 'background-color': '#f5f5f5', 'border-color': '#616161' }
                },
                {
                    selector: 'node[type = "component"]',
                    style: { 
                        'background-color': '#80deea', 
                        'border-color': '#00acc1',
                        'shape': 'round-rectangle',
                        'width': 'mapData(label.length, 5, 50, 80, 200)',
                        'height': 60,
                        'font-size': '12px',
                        'font-weight': 'bold'
                    }
                },
                
                // Edge styles
                {
                    selector: 'edge',
                    style: {
                        'curve-style': 'bezier',
                        'width': 'mapData(confidence, 0, 1, 1, 3)',
                        'line-color': '#666',
                        'target-arrow-shape': 'triangle',
                        'target-arrow-color': '#666',
                        'arrow-scale': 1.2
                    }
                },
                
                // Edge kind specific colors
                {
                    selector: 'edge[kind = "call"]',
                    style: { 'line-color': '#2196f3', 'target-arrow-color': '#2196f3' }
                },
                {
                    selector: 'edge[kind = "call_unresolved"]',
                    style: { 
                        'line-color': '#9e9e9e', 
                        'target-arrow-color': '#9e9e9e',
                        'line-style': 'dashed',
                        'opacity': 0.7
                    }
                },
                {
                    selector: 'edge[kind = "use_table"]',
                    style: { 'line-color': '#ff9800', 'target-arrow-color': '#ff9800' }
                },
                {
                    selector: 'edge[kind = "include"]',
                    style: { 'line-color': '#9c27b0', 'target-arrow-color': '#9c27b0' }
                },
                {
                    selector: 'edge[kind = "extends"]',
                    style: { 'line-color': '#4caf50', 'target-arrow-color': '#4caf50' }
                },
                {
                    selector: 'edge[kind = "implements"]',
                    style: { 'line-color': '#4caf50', 'target-arrow-color': '#4caf50', 'line-style': 'dashed' }
                },
                {
                    selector: 'edge[kind = "mixed"]',
                    style: { 'line-color': '#795548', 'target-arrow-color': '#795548', 'width': 3 }
                },
                
                // Selected/highlighted styles
                {
                    selector: 'node:selected',
                    style: {
                        'border-width': 3,
                        'border-color': '#ff6b6b',
                        'background-color': '#ffe0e0'
                    }
                },
                {
                    selector: 'edge:selected',
                    style: {
                        'line-color': '#ff6b6b',
                        'target-arrow-color': '#ff6b6b',
                        'width': 4
                    }
                }
            ],
            style: baseStyles.concat(clusterStyles, selectedStyles),
            layout: {
                name: 'dagre',
                rankDir: 'LR',
                nodeSep: 40,
                rankSep: 80,
                animate: false
            }
        });

        // Update stats
        document.getElementById('node-count').textContent = DATA.nodes ? DATA.nodes.length : 0;
        document.getElementById('edge-count').textContent = DATA.edges ? DATA.edges.length : 0;

        // Create legend
        // Create legend from clusters
        function createLegend() {
            const groups = [...new Set((DATA.nodes || []).map(n => n.group))];
            const legend = document.getElementById('legend');
            
            const groupColors = {
                'Controller': '#1976d2',
                'Service': '#388e3c',
                'Repository': '#f57c00',
                'Mapper': '#7b1fa2',
                'JSP': '#d32f2f',
                'DB': '#f9a825',
                'Code': '#616161',
                'Entity': '#9c27b0',
                'Util': '#607d8b',
                'Config': '#ff5722'
            };
            
            groups.forEach(group => {
            Object.entries(clusterColors).forEach(([cid, color]) => {
                const item = document.createElement('div');
                item.className = 'legend-item';
                
                const color = document.createElement('div');
                color.className = 'legend-color';
                color.style.backgroundColor = groupColors[group] || '#666';
                

                const colorBox = document.createElement('div');
                colorBox.className = 'legend-color';
                colorBox.style.backgroundColor = color;

                const label = document.createElement('span');
                label.textContent = group;
                
                item.appendChild(color);
                label.textContent = cid;

                item.appendChild(colorBox);
                item.appendChild(label);
                legend.appendChild(item);
            });
        }
        

        createLegend();

        // Event handlers
        function exportPng() {
            const png64 = cy.png({ 
                full: true, 
                scale: 2,
                bg: 'white'
            });
            const link = document.createElement('a');
            link.href = png64;
            link.download = 'dependency-graph.png';
            link.click();
        }

        function resetView() {
            const layout = usePhysics ? 'cose' : 'dagre';
            const layoutOptions = usePhysics ? 
                {
                    name: 'cose',
                    animate: true,
                    nodeRepulsion: 4000,
                    idealEdgeLength: 100
                } :
                {