<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Source Analyzer - ê³ ë„í™” ERD</title>
    <style>
        body, html { 
            margin: 0; 
            height: 100%; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        #toolbar { 
            padding: 12px; 
            border-bottom: 1px solid #ddd; 
            background: #f8f9fa;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        #cy { 
            width: 100%; 
            height: calc(100% - 60px); 
        }
        
        button {
            background: #007bff;
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        
        #search {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            min-width: 200px;
        }
        
        /* í–¥ìƒëœ íˆ´íŒ ìŠ¤íƒ€ì¼ */
        .tooltip {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 0;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: none;
            z-index: 2000;
            font-size: 12px;
        }
        
        .tooltip-header {
            background: #f8f9fa;
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
            border-radius: 8px 8px 0 0;
        }
        
        .tooltip-title {
            font-weight: bold;
            font-size: 14px;
            color: #212529;
            margin-bottom: 4px;
        }
        
        .tooltip-subtitle {
            font-size: 11px;
            color: #6c757d;
        }
        
        .tooltip-content {
            padding: 0;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .columns-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }
        
        .column-item {
            padding: 8px 12px;
            border-bottom: 1px solid #f1f3f4;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .column-item:last-child {
            border-bottom: none;
        }
        
        .column-item:hover {
            background-color: #f8f9fa;
        }
        
        .column-name {
            font-weight: 500;
            color: #212529;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .column-type {
            font-size: 11px;
            color: #6c757d;
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
        }
        
        .pk-icon {
            color: #dc3545;
            font-weight: bold;
            font-size: 10px;
        }
        
        .fk-icon {
            color: #007bff;
            font-weight: bold;
            font-size: 10px;
        }
        
        .nullable {
            color: #28a745;
            font-size: 10px;
        }
        
        .sample-joins {
            background: #f8f9fa;
            margin-top: 8px;
            padding: 8px 12px;
            border-radius: 0 0 8px 8px;
        }
        
        .sample-joins-title {
            font-weight: 500;
            font-size: 11px;
            color: #495057;
            margin-bottom: 6px;
        }
        
        .join-item {
            font-size: 10px;
            color: #6c757d;
            margin-bottom: 2px;
        }
        
        .info-panel {
            position: absolute;
            top: 80px;
            right: 20px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            max-width: 300px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
            z-index: 1000;
        }
        
        .stats {
            background: rgba(255, 152, 0, 0.1);
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .legend {
            display: flex;
            gap: 15px;
            font-size: 12px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-line {
            width: 20px;
            height: 2px;
            border-radius: 1px;
        }

        /* ê²¹ì¹¨ ë°©ì§€ë¥¼ ìœ„í•œ ë…¸ë“œ ìŠ¤íƒ€ì¼ ê°œì„  */
        .cy-node-selected {
            z-index: 999;
        }

        /* ì»¬ëŸ¼ ìƒì„¸ ì •ë³´ íŒ¨ë„ */
        .column-details {
            padding: 4px 0;
        }
        
        .column-comment {
            font-size: 10px;
            color: #28a745;
            font-style: italic;
            margin-top: 2px;
        }
        
        /* ê´€ê³„ì„  íˆ´íŒ ìŠ¤íƒ€ì¼ */
        .edge-tooltip {
            position: absolute;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 0;
            max-width: 380px;
            min-width: 200px;
            box-shadow: 0 8px 25px rgba(0,123,255,0.15), 0 3px 10px rgba(0,0,0,0.1);
            display: none;
            z-index: 2100;
            font-size: 12px;
            pointer-events: none;
            animation: fadeInTooltip 0.2s ease-out;
        }
        
        @keyframes fadeInTooltip {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .edge-tooltip-header {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 10px 12px;
            margin: 0;
            border-radius: 6px 6px 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 600;
            font-size: 13px;
        }
        
        .edge-tooltip-type {
            font-size: 10px;
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 500;
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .edge-tooltip-content {
            color: #495057;
            padding: 12px;
        }
        
        .join-condition {
            background: linear-gradient(135deg, #e8f4fd 0%, #f1f8ff 100%);
            border: 1px solid #b3d9ff;
            padding: 8px 12px;
            border-radius: 6px;
            margin: 8px 0;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            font-weight: 500;
            color: #0056b3;
            position: relative;
        }
        
        .join-condition::before {
            content: 'î˜¥';
            position: absolute;
            left: -5px;
            top: 50%;
            transform: translateY(-50%);
            width: 10px;
            height: 10px;
            background: #007bff;
            border-radius: 50%;
        }
        
        .edge-metadata {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 10px;
            color: #6c757d;
            margin-top: 10px;
            padding: 8px 0;
            border-top: 1px solid #e9ecef;
        }
        
        .confidence-badge {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(40,167,69,0.3);
        }
        
        .frequency-info {
            color: #6c757d;
            font-size: 10px;
        }
        
        .relation-detail {
            margin: 4px 0;
            padding: 4px 8px;
            background: #f8f9fa;
            border-left: 3px solid #007bff;
            border-radius: 0 4px 4px 0;
            font-size: 11px;
        }
        
        .relation-detail strong {
            color: #495057;
        }
    </style>
    <!-- Offline assets -->
    <script src="./static/vendor/cytoscape/cytoscape.min.js"></script>
    <script src="./static/vendor/dagre/dagre.min.js"></script>
    <script src="./static/vendor/cytoscape-dagre/cytoscape-dagre.js"></script>
    <script src="./static/vendor/cytoscape-fcose/cytoscape-fcose.js"></script>
    <script>
        const DATA = __DATA_PLACEHOLDER__;
        
        // Register extensions
        if (typeof cytoscape !== 'undefined' && typeof dagre !== 'undefined') {
            cytoscape.use(cytoscapeDagre);
        }
        if (typeof cytoscape !== 'undefined' && typeof cytoscapeFcose !== 'undefined') {
            cytoscape.use(cytoscapeFcose);
        }
    </script>
</head>
<body>
    <div id="toolbar">
        <button onclick="cy.fit()" title="í™”ë©´ì— ë§ì¶”ê¸°">ğŸ” í™”ë©´ë§ì¶¤</button>
        <button onclick="cy.center()" title="ì¤‘ì•™ ì •ë ¬">ğŸ¯ ì¤‘ì•™ì •ë ¬</button>
        <button onclick="exportPng()" title="PNGë¡œ ë‚´ë³´ë‚´ê¸°">ğŸ“· PNGì €ì¥</button>
        <button onclick="resetView()" title="ë ˆì´ì•„ì›ƒ ì´ˆê¸°í™”">ğŸ”„ ë ˆì´ì•„ì›ƒì´ˆê¸°í™”</button>
        <button onclick="toggleLayout()" title="ë ˆì´ì•„ì›ƒ ì „í™˜">ğŸ“ ë ˆì´ì•„ì›ƒ (<span id="current-layout">fcose</span>)</button>
        <input id="search" placeholder="í…Œì´ë¸” ê²€ìƒ‰..." oninput="searchNode(this.value)" />
        <div class="stats" id="stats">
            í…Œì´ë¸”: <span id="node-count">0</span> | 
            ê´€ê³„: <span id="edge-count">0</span>
        </div>
        <div class="legend" id="legend"></div>
    </div>
    
    <div id="cy"></div>
    
    <!-- í–¥ìƒëœ íˆ´íŒ -->
    <div id="tooltip" class="tooltip">
        <div class="tooltip-header">
            <div class="tooltip-title" id="tooltip-title"></div>
            <div class="tooltip-subtitle" id="tooltip-subtitle"></div>
        </div>
        <div class="tooltip-content" id="tooltip-content"></div>
    </div>
    
    <!-- ê´€ê³„ì„  íˆ´íŒ -->
    <div id="edge-tooltip" class="edge-tooltip">
        <div class="edge-tooltip-header" id="edge-tooltip-header">
            <span id="edge-tooltip-title"></span>
            <span class="edge-tooltip-type" id="edge-tooltip-type"></span>
        </div>
        <div class="edge-tooltip-content" id="edge-tooltip-content"></div>
    </div>
    
    <div id="info-panel" class="info-panel">
        <h4 id="info-title">í…Œì´ë¸” ì •ë³´</h4>
        <div id="info-content"></div>
    </div>

    <script>
        // Build Cytoscape elements
        const elements = [];
        
        // Add nodes (tables)
        for (const node of DATA.nodes || []) {
            elements.push({
                data: {
                    id: node.id,
                    label: node.label,
                    type: node.type,
                    group: node.group,
                    meta: node.meta,
                    hasComment: node.meta && node.meta.comment ? 1 : 0
                }
            });
        }
        
        // Add edges (relationships)
        for (const edge of DATA.edges || []) {
            elements.push({
                data: {
                    id: edge.id,
                    source: edge.source,
                    target: edge.target,
                    kind: edge.kind,
                    confidence: edge.confidence,
                    meta: edge.meta
                }
            });
        }

        let currentLayout = 'dagre';
        let layoutOptions = {
            'fcose': {
                name: 'fcose',
                quality: 'proof',
                randomize: true,
                animate: true,
                animationDuration: 2000,
                fit: true,
                padding: 200,
                nodeSeparation: 500, // ê²¹ì¹¨ ë°©ì§€ë¥¼ ìœ„í•´ ë…¸ë“œ ê°„ê²© ì¦ê°€
                idealEdgeLength: edge => {
                    const confidence = edge.data('confidence') || 0.5;
                    const kind = edge.data('kind') || '';
                    if (kind === 'foreign_key' || kind === 'fk_inferred') {
                        return Math.max(300, 600 - (confidence * 150)); // ê´€ê³„ì„  ê¸¸ì´ ì¦ê°€
                    }
                    return Math.max(250, 500 - (confidence * 120));
                },
                nodeRepulsion: 25000, // ë…¸ë“œ ë°˜ë°œë ¥ ì¦ê°€
                edgeElasticity: edge => {
                    const confidence = edge.data('confidence') || 0.5;
                    const kind = edge.data('kind') || '';
                    if (kind === 'foreign_key' || kind === 'fk_inferred') {
                        return confidence * 0.25;
                    }
                    return confidence * 0.2;
                },
                gravity: 0.1,
                gravityRange: 3.8,
                gravityCompound: 0.3,
                initialTemp: 200,
                coolingFactor: 0.95,
                minTemp: 1.0,
                numIter: 2500
            },
            'dagre': {
                name: 'dagre',
                nodeSep: 150, // ë…¸ë“œ ê°„ê²© ì¦ê°€
                edgeSep: 50,
                rankSep: 200, // ë ˆë²¨ ê°„ê²© ì¦ê°€
                rankDir: 'TB',
                ranker: 'longest-path',
                animate: true,
                fit: true,
                padding: 100
            }
        };

        // Initialize Cytoscape
        const cy = window.cy = cytoscape({
            container: document.getElementById('cy'),
            elements: elements,
            layout: layoutOptions[currentLayout],
            
            style: [
                {
                    selector: 'node',
                    style: {
                        'background-color': '#ffffff',
                        'border-color': data => {
                            const group = data.group;
                            if (group === 'DB') return '#007bff';
                            return '#6c757d';
                        },
                        'border-width': 2,
                        'label': 'data(label)',
                        'text-wrap': 'wrap',
                        'text-max-width': '180px',
                        'text-valign': 'center',
                        'text-halign': 'center',
                        'font-size': '14px',
                        'font-weight': 'bold',
                        'width': 'mapData(label.length, 5, 50, 100, 200)', // ë ˆì´ë¸” ê¸¸ì´ì— ë”°ë¥¸ ë™ì  í¬ê¸° ì¡°ì •
                        'height': data => {
                            const columns = data.meta?.columns || [];
                            const baseHeight = 60;
                            const columnHeight = Math.min(columns.length * 8, 100); // ìµœëŒ€ ë†’ì´ ì œí•œ
                            return baseHeight + columnHeight;
                        },
                        'shape': 'round-rectangle',
                        'z-index': 1
                    }
                },
                {
                    selector: 'node[type="table"]',
                    style: {
                        'background-color': '#e3f2fd',
                        'border-color': '#1976d2'
                    }
                },
                {
                    selector: 'node:selected',
                    style: {
                        'border-width': 4,
                        'border-color': '#ff5722',
                        'z-index': 999
                    }
                },
                {
                    selector: 'edge',
                    style: {
                        'width': data => {
                            const confidence = data.confidence || 0.5;
                            return Math.max(1, confidence * 4);
                        },
                        'line-color': data => {
                            const kind = data.kind;
                            if (kind === 'foreign_key') return '#dc3545';
                            if (kind === 'fk_inferred') return '#fd7e14';
                            if (kind === 'pk_to_pk') return '#007bff';
                            if (kind === 'non_pk_relation') return '#6c757d';
                            return '#6c757d';
                        },
                        'target-arrow-color': data => {
                            const kind = data.kind;
                            if (kind === 'foreign_key') return '#dc3545';
                            if (kind === 'fk_inferred') return '#fd7e14';
                            if (kind === 'pk_to_pk') return '#007bff';
                            if (kind === 'non_pk_relation') return '#6c757d';
                            return '#6c757d';
                        },
                        'target-arrow-shape': data => {
                            const kind = data.kind;
                            const meta = data.meta || {};
                            
                            // arrow ë©”íƒ€ë°ì´í„°ê°€ falseì´ê±°ë‚˜ relationship íƒ€ì…ì´ë©´ í™”ì‚´í‘œ ì—†ìŒ
                            if (meta.arrow === false || kind === 'relationship') {
                                return 'none';
                            }
                            // PKê°€ ì•„ë‹Œ ê´€ê³„ëŠ” í™”ì‚´í‘œ ì—†ìŒ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
                            if (kind === 'non_pk_relation') return 'none';
                            
                            return 'triangle';
                        },
                        'target-arrow-size': '10px',
                        'curve-style': 'bezier',
                        'source-endpoint': 'outside-to-node',
                        'target-endpoint': 'outside-to-node',
                        'opacity': data => {
                            const confidence = data.confidence || 0.5;
                            return Math.max(0.3, confidence);
                        }
                    }
                },
                {
                    selector: 'edge:selected',
                    style: {
                        'line-color': '#ff5722',
                        'target-arrow-color': '#ff5722',
                        'width': 4,
                        'opacity': 1
                    }
                }
            ],

            minZoom: 0.1,
            maxZoom: 5,
            wheelSensitivity: 0.2
        });

        // íˆ´íŒ ê´€ë ¨ ë³€ìˆ˜
        let tooltip = document.getElementById('tooltip');
        let edgeTooltip = document.getElementById('edge-tooltip');
        let tooltipTimeout;
        let edgeTooltipTimeout;
        let isTooltipVisible = false;
        let isEdgeTooltipVisible = false;

        // í–¥ìƒëœ íˆ´íŒ í‘œì‹œ í•¨ìˆ˜
        function showTooltip(node, x, y) {
            const data = node.data();
            const meta = data.meta || {};
            
            // íˆ´íŒ ì œëª© ì„¤ì •
            document.getElementById('tooltip-title').textContent = data.label || 'Unknown Table';
            document.getElementById('tooltip-subtitle').textContent = meta.owner ? `Owner: ${meta.owner}` : '';
            
            // ì»¬ëŸ¼ ì •ë³´ ìƒì„±
            const columns = meta.columns || [];
            const pkColumns = meta.pk_columns || [];
            const sampleJoins = meta.sample_joins || [];
            
            let contentHtml = '';
            
            if (columns.length > 0) {
                contentHtml += '<ul class="columns-list">';
                
                columns.forEach(col => {
                    const isPk = col.is_pk || pkColumns.includes(col.name);
                    const isFk = col.is_foreign_key || false;
                    
                    let columnHtml = '<li class="column-item">';
                    columnHtml += '<div>';
                    columnHtml += '<div class="column-name">';
                    
                    if (isPk) {
                        columnHtml += '<span class="pk-icon">ğŸ”‘</span>';
                    } else if (isFk) {
                        columnHtml += '<span class="fk-icon">ğŸ”—</span>';
                    }
                    
                    columnHtml += col.name;
                    
                    if (!col.nullable) {
                        columnHtml += ' <span class="nullable">NOT NULL</span>';
                    }
                    
                    columnHtml += '</div>';
                    
                    if (col.comment) {
                        columnHtml += '<div class="column-comment">' + col.comment + '</div>';
                    }
                    
                    columnHtml += '</div>';
                    columnHtml += '<span class="column-type">' + (col.data_type || 'Unknown') + '</span>';
                    columnHtml += '</li>';
                    
                    contentHtml += columnHtml;
                });
                
                contentHtml += '</ul>';
            } else {
                contentHtml = '<div style="padding: 12px; color: #6c757d;">ì»¬ëŸ¼ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
            
            // ìƒ˜í”Œ ì¡°ì¸ ì •ë³´ ì¶”ê°€
            if (sampleJoins.length > 0) {
                contentHtml += '<div class="sample-joins">';
                contentHtml += '<div class="sample-joins-title">ìƒ˜í”Œ ì¡°ì¸ ê´€ê³„</div>';
                
                sampleJoins.slice(0, 5).forEach(join => {
                    contentHtml += '<div class="join-item">';
                    contentHtml += `${join.l_table}.${join.l_col} â†’ ${join.r_table}.${join.r_col}`;
                    contentHtml += '</div>';
                });
                
                if (sampleJoins.length > 5) {
                    contentHtml += '<div class="join-item">... ë° ' + (sampleJoins.length - 5) + 'ê°œ ë”</div>';
                }
                
                contentHtml += '</div>';
            }
            
            document.getElementById('tooltip-content').innerHTML = contentHtml;
            
            // íˆ´íŒ ìœ„ì¹˜ ì¡°ì •
            tooltip.style.left = Math.min(x + 10, window.innerWidth - tooltip.offsetWidth - 20) + 'px';
            tooltip.style.top = Math.min(y - 10, window.innerHeight - tooltip.offsetHeight - 20) + 'px';
            
            tooltip.style.display = 'block';
            isTooltipVisible = true;
        }

        function hideTooltip() {
            tooltip.style.display = 'none';
            isTooltipVisible = false;
        }
        
        // ê´€ê³„ì„  íˆ´íŒ í‘œì‹œ í•¨ìˆ˜
        function showEdgeTooltip(edge, x, y) {
            const data = edge.data();
            const meta = data.meta || {};
            const kind = data.kind || 'unknown';
            const confidence = data.confidence || 0;
            
            // íˆ´íŒ ì œëª© ì„¤ì •
            const sourceNode = cy.getElementById(data.source);
            const targetNode = cy.getElementById(data.target);
            const sourceName = sourceNode.data('label') || data.source;
            const targetName = targetNode.data('label') || data.target;
            
            document.getElementById('edge-tooltip-title').textContent = `${sourceName} â†’ ${targetName}`;
            
            // ê´€ê³„ íƒ€ì… í‘œì‹œ
            let typeText = 'ê´€ê³„';
            if (kind === 'foreign_key') typeText = 'ì™¸ë˜í‚¤';
            else if (kind === 'fk_inferred') typeText = 'ì¶”ë¡ ëœ FK';
            document.getElementById('edge-tooltip-type').textContent = typeText;
            
            // ì¡°ì¸ ì¡°ê±´ ì •ë³´ ìƒì„±
            let contentHtml = '';
            
            // ì¡°ì¸ ì¡°ê±´ í‘œì‹œ
            if (meta.join_condition) {
                // ë°±ì—”ë“œì—ì„œ ì œê³µëœ ì¡°ì¸ ì¡°ê±´ ì‚¬ìš©
                contentHtml += '<div class="join-condition">';
                contentHtml += meta.join_condition;
                contentHtml += '</div>';
            } else if (meta.left_column && meta.right_column) {
                // ì»¬ëŸ¼ ì •ë³´ë¡œ ì¡°ì¸ ì¡°ê±´ ìƒì„±
                contentHtml += '<div class="join-condition">';
                contentHtml += `${sourceName}.${meta.left_column} = ${targetName}.${meta.right_column}`;
                contentHtml += '</div>';
            } else if (meta.column) {
                // ë‹¨ì¼ ì»¬ëŸ¼ ì •ë³´ë¡œ ì¡°ì¸ ì¡°ê±´ ìƒì„±
                const targetCol = meta.references ? meta.references.split('.').pop() : meta.column;
                contentHtml += '<div class="join-condition">';
                contentHtml += `${sourceName}.${meta.column} = ${targetName}.${targetCol}`;
                contentHtml += '</div>';
            } else {
                // ê¸°ë³¸í‚¤ë¡œ ëŒ€ì²´ ì¡°ì¸ ì¡°ê±´ ìƒì„±
                const sourceColumns = sourceNode.data('meta')?.pk_columns || [];
                const targetColumns = targetNode.data('meta')?.pk_columns || [];
                
                if (sourceColumns.length > 0 && targetColumns.length > 0) {
                    contentHtml += '<div class="join-condition">';
                    contentHtml += `${sourceName}.${sourceColumns[0]} = ${targetName}.${targetColumns[0]}`;
                    contentHtml += '</div>';
                }
            }
            
            // ì¶”ê°€ ì •ë³´ ì„¹ì…˜
            let additionalInfo = '';
            
            if (meta.description) {
                additionalInfo += `<div style="margin: 8px 0; color: #495057;">${meta.description}</div>`;
            }
            
            if (meta.join_type) {
                additionalInfo += `<div><strong>ì¡°ì¸ íƒ€ì…:</strong> ${meta.join_type}</div>`;
            }
            
            if (meta.relationship_type) {
                additionalInfo += `<div><strong>ê´€ê³„ ìœ í˜•:</strong> ${meta.relationship_type}</div>`;
            }
            
            if (meta.cardinality) {
                additionalInfo += `<div><strong>ì¹´ë””ë„ë¦¬í‹°:</strong> ${meta.cardinality}</div>`;
            }
            
            if (meta.constraint_name) {
                additionalInfo += `<div><strong>ì œì•½ëª…:</strong> ${meta.constraint_name}</div>`;
            }
            
            if (additionalInfo) {
                const additionalLines = additionalInfo.split('<div>').filter(line => line.trim());
                additionalLines.forEach(line => {
                    const cleanLine = line.replace('</div>', '');
                    if (cleanLine.trim()) {
                        contentHtml += '<div class="relation-detail">' + cleanLine + '</div>';
                    }
                });
            }
            
            // ë©”íƒ€ë°ì´í„° í‘œì‹œ
            contentHtml += '<div class="edge-metadata">';
            contentHtml += '<span class="frequency-info">';
            
            if (meta.frequency) {
                contentHtml += `ë¹ˆë„: ${meta.frequency}íšŒ`;
            }
            
            if (meta.pattern) {
                contentHtml += ` (íŒ¨í„´: ${meta.pattern})`;
            }
            
            contentHtml += '</span>';
            contentHtml += `<span class="confidence-badge">ì‹ ë¢°ë„: ${Math.round(confidence * 100)}%</span>`;
            contentHtml += '</div>';
            
            document.getElementById('edge-tooltip-content').innerHTML = contentHtml;
            
            // íˆ´íŒ ìœ„ì¹˜ ì¡°ì •
            edgeTooltip.style.left = Math.min(x + 10, window.innerWidth - 370) + 'px';
            edgeTooltip.style.top = Math.max(y - 10, 10) + 'px';
            
            edgeTooltip.style.display = 'block';
            isEdgeTooltipVisible = true;
        }
        
        function hideEdgeTooltip() {
            edgeTooltip.style.display = 'none';
            isEdgeTooltipVisible = false;
        }

        // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ - ë…¸ë“œ
        cy.on('mouseover', 'node', function(event) {
            const node = event.target;
            clearTimeout(tooltipTimeout);
            hideEdgeTooltip(); // ê´€ê³„ì„  íˆ´íŒ ìˆ¨ê¹€
            
            tooltipTimeout = setTimeout(() => {
                const renderedPosition = event.renderedPosition;
                showTooltip(node, renderedPosition.x, renderedPosition.y);
            }, 500); // 0.5ì´ˆ ì§€ì—°
        });

        cy.on('mouseout', 'node', function(event) {
            clearTimeout(tooltipTimeout);
            setTimeout(() => {
                if (!isTooltipVisible) return;
                hideTooltip();
            }, 100);
        });
        
        // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ - ê´€ê³„ì„ 
        cy.on('mouseover', 'edge', function(event) {
            const edge = event.target;
            clearTimeout(edgeTooltipTimeout);
            hideTooltip(); // ë…¸ë“œ íˆ´íŒ ìˆ¨ê¹€
            
            edgeTooltipTimeout = setTimeout(() => {
                const renderedPosition = event.renderedPosition;
                showEdgeTooltip(edge, renderedPosition.x, renderedPosition.y);
            }, 300); // 0.3ì´ˆ ì§€ì—°
        });
        
        cy.on('mouseout', 'edge', function(event) {
            clearTimeout(edgeTooltipTimeout);
            setTimeout(() => {
                if (!isEdgeTooltipVisible) return;
                hideEdgeTooltip();
            }, 100);
        });

        // íˆ´íŒì´ ë§ˆìš°ìŠ¤ ì˜¤ë²„ë  ë•Œ ìˆ¨ê¸°ì§€ ì•ŠìŒ
        tooltip.addEventListener('mouseenter', function() {
            clearTimeout(tooltipTimeout);
        });

        tooltip.addEventListener('mouseleave', function() {
            hideTooltip();
        });

        // ìº”ë²„ìŠ¤ í´ë¦­ ì‹œ íˆ´íŒ ìˆ¨ê¹€
        cy.on('tap', function(event) {
            if (event.target === cy) {
                hideTooltip();
                hideEdgeTooltip();
            }
        });
        
        // ê´€ê³„ì„  íˆ´íŒ ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸
        edgeTooltip.addEventListener('mouseenter', function() {
            clearTimeout(edgeTooltipTimeout);
        });
        
        edgeTooltip.addEventListener('mouseleave', function() {
            hideEdgeTooltip();
        });

        // Functions for toolbar buttons
        function resetView() {
            cy.layout(layoutOptions[currentLayout]).run();
            cy.fit();
        }

        function toggleLayout() {
            currentLayout = currentLayout === 'fcose' ? 'dagre' : 'fcose';
            document.getElementById('current-layout').textContent = currentLayout;
            resetView();
        }

        function exportPng() {
            const png = cy.png({
                scale: 2,
                full: true,
                bg: 'white'
            });
            
            const link = document.createElement('a');
            link.download = 'erd-enhanced.png';
            link.href = png;
            link.click();
        }

        function searchNode(query) {
            cy.elements().removeClass('highlighted');
            
            if (!query.trim()) {
                cy.elements().style('opacity', 1);
                return;
            }
            
            const matchedNodes = cy.nodes().filter(node => {
                const label = node.data('label').toLowerCase();
                const tableName = node.data('meta')?.table_name?.toLowerCase() || '';
                const owner = node.data('meta')?.owner?.toLowerCase() || '';
                
                return label.includes(query.toLowerCase()) || 
                       tableName.includes(query.toLowerCase()) || 
                       owner.includes(query.toLowerCase());
            });
            
            if (matchedNodes.length > 0) {
                cy.elements().style('opacity', 0.3);
                matchedNodes.style('opacity', 1);
                matchedNodes.connectedEdges().style('opacity', 0.8);
                cy.fit(matchedNodes, 100);
            } else {
                cy.elements().style('opacity', 1);
            }
        }

        // Update stats
        document.getElementById('node-count').textContent = (DATA.nodes || []).length;
        document.getElementById('edge-count').textContent = (DATA.edges || []).length;

        // Initial fit
        cy.ready(function() {
            cy.fit();
        });
        
        console.log('ê³ ë„í™” ERD ì´ˆê¸°í™” ì™„ë£Œ:', {
            nodes: (DATA.nodes || []).length,
            edges: (DATA.edges || []).length,
            layout: currentLayout
        });
    </script>
</body>
</html>