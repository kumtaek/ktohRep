# 소스 분석기 정확성 개선 분석 보고서

## 1. 개요
본 보고서는 SourceAnalyzer 프로젝트의 전반적인 소스 코드 및 마크다운 문서를 심층적으로 검토하여, 시스템의 정확성을 개선할 수 있는 방안을 모색합니다. 정적 분석의 본질적인 한계와 동적 요소(예: MyBatis 동적 SQL)로 인한 불확실성을 인지하고, 이를 최소화하며 신뢰도 높은 분석 결과를 제공하기 위한 설계 개선 방안을 제시합니다.

## 2. 핵심 구성 요소별 정확성 분석

### 2.1. 핵심 파싱 로직 (java_parser.py, jsp_mybatis_parser.py, sql_parser.py)
*   **java_parser.py**:
    *   **문제점**: 고급 Java 구문(어노테이션, 제네릭, 람다 등) 처리 미흡, 외부 라이브러리 의존성 해결 부족, 오버로드된 메서드 식별의 어려움, 동적 코드(리플렉션) 처리 한계.
    *   **정확성 영향**: 누락된 의존성, 잘못된 호출 그래프, 부정확한 타입 추론으로 인한 분석 오류.
*   **jsp_mybatis_parser.py**:
    *   **문제점**: JSP의 복잡한 구조(HTML, JSTL, 스크립틀릿 혼합) 처리, **MyBatis 동적 SQL의 정확한 런타임 SQL 재구성의 어려움 (가장 중요)**, 파라미터 매핑 오류, JSP 내장 SQL/Java 코드 처리 미흡.
    *   **정확성 영향**: 동적 SQL의 오해석으로 인한 SQL 분석 오류, 취약점 탐지 실패, 데이터 흐름 추적 오류.
*   **sql_parser.py**:
    *   **문제점**: 다양한 SQL Dialect(Oracle 외) 지원 부족, 복잡한 쿼리(중첩 쿼리, CTE, SP 호출) 파싱의 어려움, 불완전한 동적 SQL 입력에 대한 취약성, DB 스키마 정보 활용 부족.
    *   **정확성 영향**: SQL 구문 오해석, 테이블/컬럼 식별 오류, 취약점 탐지 실패.

### 2.2. 데이터 처리 및 메타데이터 추출 (metadata_engine.py, metadata_enhancement_engine.py, db_comment_loader.py, database.py)
*   **문제점**: 파싱 단계의 오류가 메타데이터에 전파될 가능성, 증분 분석 시 메타데이터 일관성 유지의 어려움, 대용량 데이터 처리 시 성능과 정확성 간의 트레이드오프.
*   **정확성 영향**: 부정확하거나 불완전한 메타데이터는 모든 후속 분석(취약점, 시각화, LLM 질의응답)의 신뢰도를 저하시킴.

### 2.3. 보안 및 취약점 탐지 (vulnerability_detector.py)
*   **문제점**: **False Positive (낮은 정밀도)** 및 **False Negative (낮은 재현율)** 문제, 불완전한 데이터 흐름 분석, 언어/프레임워크 특화 규칙 부족, 설정 취약점 탐지 한계.
*   **정확성 영향**: 실제 취약점 누락(심각), 오탐으로 인한 개발자 피로도 증가.

### 2.4. 유틸리티 및 신뢰도 계산 (confidence_calculator.py, csv_loader.py, large_file_processor.py, logger.py)
*   **confidence_calculator.py**:
    *   **문제점**: 신뢰도 계산 규칙의 주관성, 세분화 부족, 상위 단계 정확성에 대한 의존성, 가중치 부여의 적절성 검증 부족.
    *   **정확성 영향**: 분석 결과의 신뢰도를 잘못 평가하여 의사결정에 혼란 초래.
*   **large_file_processor.py**:
    *   **문제점**: 대용량 파일 청크 처리 시 컨텍스트 손실, 청크 경계를 넘는 의존성 누락 가능성.
    *   **정확성 영향**: 불완전한 분석으로 인한 정확성 저하.

## 3. 문서화 (README.md, prd_final.md 등)
*   **README.md**: 시스템 개요, 빠른 시작, 시각화 예시 등 전반적으로 명확하고 일관성 있음.
*   **prd_final.md**: 프로젝트의 요구사항 및 설계에 대한 상세한 정보 제공. 재현율 우선, CONFIDENCE 추적, LLM 활용 등 정확성 관련 핵심 원칙 명시.
*   **개선점**:
    *   각 파서의 **명시적인 한계점** 및 이것이 신뢰도에 미치는 영향에 대한 상세 설명 부족.
    *   신뢰도 계산 공식의 **구체적인 파라미터 정의 및 가중치 결정 로직**에 대한 추가 설명 필요.
    *   취약점 탐지 규칙(OWASP Top 10 등)에 대한 **상세 문서화 및 탐지/미탐지 시나리오 예시** 부족.
    *   정확성 검증을 위한 **테스트 케이스의 상세화** 필요.

## 4. 정확성 개선을 위한 설계 계획

### 4.1. 핵심 파싱 로직 강화 (최우선 순위)
1.  **MyBatis 동적 SQL 정밀 분석**:
    *   **조건부 경로 분석**: `<if>`, `<choose>` 등 조건부 로직을 심층 분석하여 가능한 SQL 쿼리 변형들을 생성하고, 각 변형에 대한 신뢰도를 부여.
    *   **파라미터 타입 추론**: Java 코드 분석을 통해 MyBatis 파라미터의 타입을 추론하여 동적 SQL 해석 정확도 향상.
    *   **메타데이터 저장**: `sql_units` 테이블에 다중 SQL 변형 및 신뢰도를 저장하도록 확장.
2.  **Java 외부 의존성 해결**:
    *   **빌드 도구 통합**: Maven/Gradle 빌드 파일(`pom.xml`, `build.gradle`)과 연동하여 클래스패스 및 외부 라이브러리 의존성 정보 추출.
    *   **심볼 테이블 강화**: 외부 라이브러리의 클래스/메서드를 포함하는 심볼 테이블 구축으로 정확한 호출 관계 식별.
3.  **SQL Dialect 및 스키마 활용**:
    *   **다이얼렉트 지원 확장**: Oracle 외 MySQL, PostgreSQL 등 주요 SQL Dialect 지원 강화.
    *   **스키마 기반 유효성 검증**: `db_tables`, `db_columns` 메타데이터를 활용하여 SQL 구문의 테이블/컬럼 존재 여부 검증.

### 4.2. 신뢰도 계산 정교화
1.  **세분화된 신뢰도 점수**:
    *   메타데이터 내 각 요소(예: `edge`, `join`, `required_filter`)별로 신뢰도 점수를 부여.
    *   불확실성의 원천(정적 분석, 동적 SQL, LLM 보강 등)을 명시적으로 반영하여 가중치 조정.
2.  **LLM 보강 신뢰도 통합**:
    *   `enrichment_logs`에 `pre_conf`, `post_conf`를 상세 기록하여 LLM의 신뢰도 기여도 추적.
    *   LLM 생성 결과에 대한 자동 유효성 검증 로직 구현.

### 4.3. 취약점 탐지 개선
1.  **데이터 흐름 분석 강화 (Source to Sink)**:
    *   메서드 호출 및 파일 경계를 넘나드는 **Inter-Procedural 데이터 흐름 추적** 기능 확장.
    *   **Taint Analysis (오염원 분석)** 구현으로 민감한 데이터의 흐름을 정밀하게 추적.
2.  **정교한 취약점 규칙 및 시그니처**:
    *   코드 컨텍스트를 고려한 **컨텍스트 인지 규칙** 개발.
    *   OWASP Top 10 및 CWE ID에 명시적으로 부합하는 규칙 강화.
    *   MyBatis `${...}` 패턴에 대한 **커스텀 SQL Injection 규칙** 강화.
    *   (향후) CodeQL, Semgrep 등 오픈소스 SAST 도구 통합.

### 4.4. 종합적인 정확성 테스트 및 검증
1.  **파서 단위 테스트**: 각 파서의 엣지 케이스, 동적 SQL, 외부 의존성 해결, 신뢰도 영향 등을 검증하는 광범위한 단위 테스트 작성.
2.  **통합 테스트**: 파싱부터 메타데이터 생성, 데이터 흐름 추적까지의 엔드투엔드 흐름 검증.
3.  **취약점 탐지 엔드투엔드 테스트**: 알려진 취약 코드 및 정상 코드를 활용하여 False Positive/Negative 비율 측정 및 신뢰도 검증.
4.  **회귀 테스트 및 자동화**: 모든 정확성 테스트를 CI/CD 파이프라인에 통합하여 자동화.

### 4.5. 문서화 동기화 및 사용자 피드백
1.  **상세 파서 문서화**: 각 파서의 기능, 한계점, 신뢰도 영향, 오류 처리 방안을 명시한 문서 작성.
2.  **신뢰도 계산 가이드**: 신뢰도 계산 로직, 파라미터, 가중치, LLM 보강 영향 등을 상세히 설명하는 가이드 작성.
3.  **취약점 탐지 규칙서**: 구현된 모든 취약점 탐지 규칙, OWASP/CWE 분류, 탐지 패턴, 예시 코드 등을 포함하는 규칙서 작성.
4.  **테스트 케이스 문서화**: 정확성 중심의 테스트 케이스를 상세히 기술.
5.  **사용자 피드백 루프**: 정확성 문제(오탐, 미탐, 신뢰도 오류) 보고 및 분석을 위한 명확한 프로세스 구축.

## 5. 결론
SourceAnalyzer의 정확성 개선은 핵심 파싱 로직의 정교화, 신뢰도 계산의 세분화, 취약점 탐지 능력 강화, 그리고 이를 뒷받침하는 철저한 테스트 및 문서화가 유기적으로 결합될 때 달성될 수 있습니다. 특히 MyBatis 동적 SQL 처리와 Java 외부 의존성 해결은 최우선적으로 개선해야 할 영역입니다. 이 설계 계획을 통해 SourceAnalyzer는 더욱 신뢰할 수 있고 가치 있는 분석 결과를 제공할 수 있을 것입니다.