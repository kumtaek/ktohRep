# 메타데이터베이스 생성 기능 및 구성 가이드

## 📋 개요

**작성일**: 2025-09-06  
**프로젝트**: SourceAnalyzer  

**개발목적**: 신규입사자가 소스만 보고 업무파악하는데 어려움을 도와주고자 메타정보를 구축하는 것이고, 이를 이용해 LLM을 이용해서 자연어로 질의 응답을 해주거나, 도움이 되는 문서(e.g. ERD, 컴퍼넌트다이어그램 등)를 생성해 내고자 한다.


**문서내용**: 메타데이터베이스 생성 기능, 스키마 구성, 데이터 레이아웃 및 조회 방법 가이드 
**대상**: sampleSrc 프로젝트 메타디비 분석

## 🏗️ 메타데이터베이스 생성 기능

### 1. 생성 명령어

```bash
# 기본 생성
cd E:\SourceAnalyzer.git
set PYTHONPATH=E:\SourceAnalyzer.git
venvSrcAnalyzer\Scripts\python.exe phase1/main.py --project-name sampleSrc

# 상세 로그와 함께 생성
cd E:\SourceAnalyzer.git
set PYTHONPATH=E:\SourceAnalyzer.git
venvSrcAnalyzer\Scripts\python.exe phase1/main.py --project-name sampleSrc --verbose
```

### 2. 생성 과정

1. **프로젝트 초기화**: 프로젝트 정보 등록
2. **소스 파일 수집**: 지정된 경로에서 소스 파일 탐색
3. **파일 분석**: Java, JSP, XML 파일 파싱
4. **메타데이터 추출**: 클래스, 메서드, SQL Unit 정보 추출
5. **청크 생성**: 지능형 청킹으로 세분화된 청크 생성
6. **엣지 생성**: 동적 분석으로 관계 정보 생성
7. **데이터베이스 저장**: SQLite 데이터베이스에 저장

### 3. 생성 결과

- **데이터베이스 파일**: `./project/sampleSrc/metadata.db`
- **총 테이블 수**: 17개
- **총 레코드 수**: 2,442개

## 📊 메타데이터베이스 스키마 구성

### 1. 핵심 테이블 구조

#### Projects 테이블

```sql
CREATE TABLE projects (
    project_id INTEGER PRIMARY KEY,
    root_path TEXT NOT NULL,
    name VARCHAR(255),
    created_at DATETIME,
    updated_at DATETIME
);
```

#### Files 테이블

```sql
CREATE TABLE files (
    file_id INTEGER PRIMARY KEY,
    project_id INTEGER,
    path TEXT NOT NULL,
    language VARCHAR(50),
    hash VARCHAR(64),
    loc INTEGER,
    mtime DATETIME,
    llm_summary TEXT,
    llm_summary_confidence FLOAT
);
```

#### Classes 테이블

```sql
CREATE TABLE classes (
    class_id INTEGER PRIMARY KEY,
    file_id INTEGER,
    fqn TEXT,
    name VARCHAR(255) NOT NULL,
    start_line INTEGER,
    end_line INTEGER,
    modifiers TEXT,
    annotations TEXT,
    llm_summary TEXT,
    llm_summary_confidence FLOAT
);
```

#### Methods 테이블

```sql
CREATE TABLE methods (
    method_id INTEGER PRIMARY KEY,
    class_id INTEGER,
    name VARCHAR(255) NOT NULL,
    start_line INTEGER,
    end_line INTEGER,
    modifiers TEXT,
    parameters TEXT,
    return_type TEXT,
    llm_summary TEXT,
    llm_summary_confidence FLOAT
);
```

#### Chunks 테이블

```sql
CREATE TABLE chunks (
    chunk_id INTEGER PRIMARY KEY,
    target_type VARCHAR(50) NOT NULL,
    target_id INTEGER NOT NULL,
    content TEXT,
    token_count INTEGER,
    hash VARCHAR(64),
    created_at DATETIME
);
```

#### Edges 테이블

```sql
CREATE TABLE edges (
    edge_id INTEGER PRIMARY KEY,
    project_id INTEGER NOT NULL,
    src_type VARCHAR(50) NOT NULL,
    src_id INTEGER NOT NULL,
    dst_type VARCHAR(50) NOT NULL,
    dst_id INTEGER,
    edge_kind VARCHAR(50) NOT NULL,
    confidence FLOAT,
    meta TEXT,
    created_at DATETIME
);
```

### 2. 전체 테이블 목록

| 테이블명                    | 설명             | 레코드 수  |
| ----------------------- | -------------- | ------ |
| **projects**            | 프로젝트 정보        | 1개     |
| **files**               | 파일 정보          | 84개    |
| **classes**             | 클래스 정보         | 124개   |
| **methods**             | 메서드 정보         | 551개   |
| **chunks**              | 청크 정보          | 1,222개 |
| **edges**               | 관계 정보          | 461개   |
| **db_tables**           | DB 테이블 정보      | 0개     |
| **db_columns**          | DB 컬럼 정보       | 0개     |
| **db_pk**               | DB PK 정보       | 0개     |
| **java_imports**        | Java Import 정보 | 0개     |
| **joins**               | SQL 조인 정보      | 0개     |
| **code_metrics**        | 코드 메트릭         | 0개     |
| **db_views**            | DB 뷰 정보        | 0개     |
| **duplicate_instances** | 중복 인스턴스        | 0개     |
| **duplicates**          | 중복 정보          | 0개     |
| **edge_hints**          | 엣지 힌트          | 0개     |
| **embeddings**          | 임베딩 정보         | 0개     |
| **enrichment_logs**     | 보강 로그          | 0개     |
| **vulnerability_fixes** | 취약점 수정         | 0개     |

## 📈 데이터 구성 현황

### 1. 프로젝트 정보

```sql
SELECT * FROM projects;
```

**결과:**

```
project_id: 1
root_path: E:\SourceAnalyzer.git\project\sampleSrc
name: sampleSrc
created_at: 2025-09-05 10:28:33.141161
updated_at: 2025-09-05 15:01:56.823109
```

### 2. 파일 정보

#### 파일 언어별 분포

```sql
SELECT language, COUNT(*) as count FROM files GROUP BY language;
```

**결과:**

```
.java: 48개
.xml: 12개
jsp: 24개
```

#### 파일 샘플 데이터

```sql
SELECT file_id, path, language, loc FROM files LIMIT 5;
```

**결과:**

```
1|ErrorController.java|.java|109
2|MixedErrorController.java|.java|100
3|ProductController.java|.java|102
4|SyntaxErrorController.java|.java|64
5|UserController.java|.java|89
```

### 3. 클래스 정보

#### 클래스 샘플 데이터

```sql
SELECT class_id, name, fqn, start_line, end_line FROM classes LIMIT 5;
```

**결과:**

```
1|ErrorController|NULL|1|1
2|MixedErrorController|NULL|1|1
3|ProductController|NULL|1|1
4|SyntaxErrorController|NULL|1|1
5|UserController|NULL|1|1
```

### 4. 청크 정보

#### 청크 타입별 분포

```sql
SELECT target_type, COUNT(*) as count FROM chunks GROUP BY target_type;
```

**결과:**

```
file: 1,062개
class: 20개
sql_unit: 140개
```

#### 청크 샘플 데이터

```sql
SELECT chunk_id, target_type, target_id, token_count, hash FROM chunks LIMIT 5;
```

**결과:**

```
1|file|1|18|0727f31f263464c668e902d480273cba
2|file|1|7|616aed488d4213b4fc7e294f9b59e863
3|file|1|44|141eaa7347408b3dba6429b8a7db7d0f
4|file|1|38|be2869fffa0b829f117460dba0ba77c6
5|file|1|34|91c9dc6ee61e263baa485000963c70aa
```

### 5. 엣지 정보

#### 엣지 타입별 분포

```sql
SELECT edge_kind, COUNT(*) as count FROM edges GROUP BY edge_kind;
```

**결과:**

```
import: 149개
dependency: 48개
data_flow: 216개
calls: 33개
uses: 12개
renders: 3개
```

#### 엣지 샘플 데이터

```sql
SELECT src_type, src_id, dst_type, dst_id, edge_kind, confidence, meta FROM edges LIMIT 3;
```

**결과:**

```
class|1|class|13|import|1.0|ErrorController import User
class|1|class|18|import|1.0|ErrorController import UserService
class|2|class|13|import|1.0|MixedErrorController import User
```

## 🔍 데이터 조회 방법

### 1. 기본 조회 쿼리

#### 프로젝트 정보 조회

```sql
-- 프로젝트 기본 정보
SELECT * FROM projects;

-- 프로젝트별 파일 수
SELECT p.name, COUNT(f.file_id) as file_count 
FROM projects p 
LEFT JOIN files f ON p.project_id = f.project_id 
GROUP BY p.project_id, p.name;
```

#### 파일 정보 조회

```sql
-- 언어별 파일 수
SELECT language, COUNT(*) as count 
FROM files 
GROUP BY language;

-- 파일별 라인 수
SELECT path, loc 
FROM files 
ORDER BY loc DESC 
LIMIT 10;

-- 특정 언어 파일 조회
SELECT file_id, path, loc 
FROM files 
WHERE language = '.java' 
ORDER BY loc DESC;
```

#### 클래스 정보 조회

```sql
-- 클래스 목록
SELECT class_id, name, fqn, start_line, end_line 
FROM classes 
ORDER BY name;

-- 파일별 클래스 수
SELECT f.path, COUNT(c.class_id) as class_count 
FROM files f 
LEFT JOIN classes c ON f.file_id = c.file_id 
GROUP BY f.file_id, f.path 
ORDER BY class_count DESC;
```

#### 메서드 정보 조회

```sql
-- 클래스별 메서드 수
SELECT c.name, COUNT(m.method_id) as method_count 
FROM classes c 
LEFT JOIN methods m ON c.class_id = m.class_id 
GROUP BY c.class_id, c.name 
ORDER BY method_count DESC;

-- 메서드 목록
SELECT c.name as class_name, m.name as method_name, m.start_line, m.end_line 
FROM methods m 
JOIN classes c ON m.class_id = c.class_id 
ORDER BY c.name, m.start_line;
```

### 2. 청크 조회 쿼리

#### 청크 통계 조회

```sql
-- 청크 타입별 통계
SELECT target_type, COUNT(*) as count, AVG(token_count) as avg_tokens 
FROM chunks 
GROUP BY target_type;

-- 파일별 청크 수
SELECT target_id, COUNT(*) as chunk_count 
FROM chunks 
WHERE target_type = 'file' 
GROUP BY target_id 
ORDER BY chunk_count DESC 
LIMIT 10;
```

#### 청크 내용 조회

```sql
-- 특정 파일의 청크 내용
SELECT chunk_id, content, token_count 
FROM chunks 
WHERE target_type = 'file' AND target_id = 1 
ORDER BY chunk_id;

-- 토큰 수가 많은 청크
SELECT chunk_id, target_type, target_id, token_count, content 
FROM chunks 
ORDER BY token_count DESC 
LIMIT 10;
```

### 3. 엣지 조회 쿼리

#### 엣지 통계 조회

```sql
-- 엣지 타입별 통계
SELECT edge_kind, COUNT(*) as count, AVG(confidence) as avg_confidence 
FROM edges 
GROUP BY edge_kind;

-- 소스-타겟 타입별 관계
SELECT src_type, dst_type, edge_kind, COUNT(*) as count 
FROM edges 
GROUP BY src_type, dst_type, edge_kind 
ORDER BY count DESC;
```

#### 관계 분석 쿼리

```sql
-- Import 관계 조회
SELECT src_type, src_id, dst_type, dst_id, meta 
FROM edges 
WHERE edge_kind = 'import' 
ORDER BY src_id;

-- 의존성 관계 조회
SELECT src_type, src_id, dst_type, dst_id, confidence 
FROM edges 
WHERE edge_kind = 'dependency' 
ORDER BY confidence DESC;

-- 데이터 흐름 관계 조회
SELECT src_type, src_id, dst_type, dst_id, meta 
FROM edges 
WHERE edge_kind = 'data_flow' 
LIMIT 10;
```

### 4. 통합 분석 쿼리

#### 프로젝트 전체 통계

```sql
-- 프로젝트 전체 통계
SELECT 
    (SELECT COUNT(*) FROM files) as total_files,
    (SELECT COUNT(*) FROM classes) as total_classes,
    (SELECT COUNT(*) FROM methods) as total_methods,
    (SELECT COUNT(*) FROM chunks) as total_chunks,
    (SELECT COUNT(*) FROM edges) as total_edges;
```

#### 파일-클래스-메서드 계층 구조

```sql
-- 파일별 클래스 및 메서드 수
SELECT 
    f.path,
    f.language,
    f.loc,
    COUNT(DISTINCT c.class_id) as class_count,
    COUNT(DISTINCT m.method_id) as method_count
FROM files f
LEFT JOIN classes c ON f.file_id = c.file_id
LEFT JOIN methods m ON c.class_id = m.class_id
GROUP BY f.file_id, f.path, f.language, f.loc
ORDER BY f.loc DESC;
```

#### 청크-엣지 통합 분석

```sql
-- 청크와 엣지 통합 통계
SELECT 
    c.target_type,
    COUNT(DISTINCT c.target_id) as unique_targets,
    COUNT(c.chunk_id) as total_chunks,
    COUNT(e.edge_id) as total_edges
FROM chunks c
LEFT JOIN edges e ON c.target_type = e.src_type AND c.target_id = e.src_id
GROUP BY c.target_type
ORDER BY total_chunks DESC;
```

## 🛠️ 메타데이터베이스 관리

### 1. 데이터베이스 백업

```bash
# SQLite 데이터베이스 백업
sqlite3 ./project/sampleSrc/metadata.db ".backup backup_metadata.db"
```

### 2. 데이터베이스 최적화

```sql
-- 인덱스 생성
CREATE INDEX idx_files_project ON files(project_id);
CREATE INDEX idx_classes_file ON classes(file_id);
CREATE INDEX idx_methods_class ON methods(class_id);
CREATE INDEX idx_chunks_target ON chunks(target_type, target_id);
CREATE INDEX idx_edges_src ON edges(src_type, src_id);
CREATE INDEX idx_edges_dst ON edges(dst_type, dst_id);

-- 통계 업데이트
ANALYZE;
```

### 3. 데이터 정리

```sql
-- 중복 청크 제거
DELETE FROM chunks 
WHERE chunk_id NOT IN (
    SELECT MIN(chunk_id) 
    FROM chunks 
    GROUP BY target_type, target_id, hash
);

-- 빈 메타 정보 정리
UPDATE edges SET meta = NULL WHERE meta = '';
UPDATE chunks SET content = NULL WHERE content = '';
```

## 📋 활용 시나리오

### 1. 코드 분석

- **파일 구조 분석**: 프로젝트의 파일 구성 파악
- **클래스 관계 분석**: 클래스 간 의존성 분석
- **메서드 호출 분석**: 메서드 간 호출 관계 분석

### 2. 품질 관리

- **코드 메트릭**: 라인 수, 복잡도 분석
- **중복 코드 검출**: 중복 청크 및 메서드 검출
- **의존성 분석**: 순환 의존성 및 복잡도 분석

### 3. 문서화

- **API 문서 생성**: 클래스 및 메서드 정보 기반
- **아키텍처 다이어그램**: 관계 정보 기반 시각화
- **코드 가이드**: 파일 구조 및 네이밍 규칙 분석

### 4. 리팩토링 지원

- **영향도 분석**: 변경 시 영향받는 코드 식별
- **의존성 추적**: 특정 클래스/메서드의 사용처 추적
- **모듈화 분석**: 모듈 간 결합도 분석

## 🎯 결론

SourceAnalyzer의 메타데이터베이스는 다음과 같은 특징을 가집니다:

### 주요 특징

1. **완전한 소스 분석**: 파일, 클래스, 메서드, 청크, 엣지 정보 저장
2. **관계 중심 설계**: 코드 간 의존성과 관계 정보 중심
3. **확장 가능한 구조**: 새로운 분석 정보 추가 가능
4. **효율적인 조회**: 인덱스 기반 빠른 조회 지원

### 활용 가치

1. **코드 이해**: 프로젝트 구조와 관계 파악
2. **품질 관리**: 코드 메트릭 및 품질 분석
3. **문서화**: 자동 문서 생성 및 시각화
4. **리팩토링**: 안전한 코드 변경 지원

이 메타데이터베이스를 통해 소스 코드의 완전한 분석과 이해가 가능하며, 다양한 개발 활동을 지원할 수 있습니다.

---

**작성자**: AI Assistant  
**작성일**: 2025-09-06  
**데이터베이스**: sampleSrc 프로젝트 메타디비  
**검증 상태**: ✅ 완료
