# Q_20250905_2032_SQL과다추출.md

## 질문 개요

SQL Units가 명세서 대비 **103.2% 과다 추출되는 문제**가 발생하고 있습니다 (명세서 31개 vs 메타디비 63개).

## 전후 배경

### 현재 결과
- **SQL_UNITS**: 63개 추출 (명세서 31개 대비 +32개, +103.2% 과대)
- **XML 파일**: 4개 MyBatis 매퍼 파일 정상 인식
- **MyBatis 파싱 로그**: "SQL Units 9개", "SQL Units 9개", "SQL Units 9개", "SQL Units 8개"

### 명세서 기준 SQL 분포
```
MyBatis 쿼리 인식: 31개 쿼리
- UserMapper.xml: 예상 7-8개 쿼리
- ProductMapper.xml: 예상 6-7개 쿼리  
- BrokenMapper.xml: 예상 8-9개 쿼리
- MixedErrorMapper.xml: 예상 7-8개 쿼리
총 예상: 31개 SQL 쿼리
```

### 실제 로그 분석
```
MyBatis 파싱 결과: SQL Units 9개 (1번째 파일)
MyBatis 파싱 결과: SQL Units 9개 (2번째 파일)  
MyBatis 파싱 결과: SQL Units 9개 (3번째 파일)
MyBatis 파싱 결과: SQL Units 8개 (4번째 파일)
총 계산: 9 + 9 + 9 + 8 = 35개 (로그 기준)
```

**불일치**: 로그 35개 vs 실제 DB 63개 (28개 추가 발생)

## 문제점 상세 분석

### 1. MyBatis XML 파일 중복 처리 의심
**사례 파일**: `UserMapper.xml`

**의심 원인**:
- 동일한 파일이 여러 번 파싱됨
- XML 파일과 MyBatis 파일로 중복 처리
- 파일 경로 정규화 문제로 인한 중복 등록

### 2. SQL 단위 세분화 과도
**예상 문제**:
- 하나의 복잡한 쿼리가 여러 개의 SQL Unit으로 분할됨
- 동적 쿼리의 각 조건문이 별도 SQL Unit으로 생성
- `<if>`, `<choose>`, `<foreach>` 등 동적 요소가 개별 Unit으로 처리

**사례 분석 필요**:
```xml
<select id="findUsers" resultType="User">
    SELECT * FROM users 
    <where>
        <if test="name != null">AND name = #{name}</if>
        <if test="age != null">AND age = #{age}</if>
    </where>
</select>
```
- 기대값: 1개 SQL Unit
- 실제값: 3개 SQL Unit (메인 쿼리 + if 조건 2개)?

### 3. Java 파일에서의 SQL 추출 중복
**의심 원인**:
- MyBatis 매퍼 XML에서 추출된 SQL
- 해당 매퍼를 호출하는 Java 파일에서도 SQL로 인식
- 문자열 내 SQL 쿼리가 추가로 추출됨

**확인 필요**:
- Java 파일에서 추출된 SQL 문자열 수
- MyBatis 어노테이션(`@Select`, `@Insert` 등)의 SQL 중복 추출

### 4. SQL 단위 정의 기준 불일치
**명세서 기준**: "MyBatis 쿼리 인식: 31개"
**현재 처리**: SQL Unit을 더 세분화하여 계산

**기준 차이 추정**:
- 명세서: `<select>`, `<insert>`, `<update>`, `<delete>` 태그 단위
- 현재 시스템: 동적 SQL 조각까지 포함한 모든 SQL 문장

## 핵심 질문

다음 사항들에 대한 해결 방안을 제시해 주세요:

### 1. SQL Unit 계산 기준 명확화
**질문**: 명세서의 "31개 쿼리"와 현재 "63개 SQL Units"의 기준 차이가 무엇인가요?
- MyBatis XML의 주요 태그(`<select>`, `<insert>` 등) 기준 계산 방법
- 동적 SQL 조각의 처리 방향 (포함 vs 제외)
- SQL Unit 정의 표준화 방안

### 2. 중복 처리 방지
**질문**: 동일한 SQL이 여러 경로로 중복 추출되는 것을 어떻게 방지할 수 있나요?
- MyBatis XML vs Java 어노테이션 중복 제거
- 파일 경로 정규화를 통한 중복 파일 처리 방지
- SQL 내용 기반 중복 검출 및 제거 로직

### 3. MyBatis 동적 쿼리 처리 방법
**질문**: MyBatis의 동적 SQL 요소를 어떻게 적절히 처리해야 하나요?
- `<if>`, `<choose>`, `<foreach>` 등의 조건부 SQL 처리 방향
- 동적 쿼리를 하나의 단위로 보는 방법
- 런타임 SQL과 템플릿 SQL의 구분 방법

### 4. SQL 추출 정확도 검증
**질문**: 각 매퍼 파일에서 정확히 몇 개의 SQL이 추출되어야 하는지 어떻게 확인할 수 있나요?
- 매퍼 파일별 상세 분석 방법
- 예상 SQL 수와 실제 추출 수 비교 방법
- SQL Unit 추출 로직의 단위 테스트 방안

### 5. 정밀도 조정 방향
**질문**: 63개를 31개로 맞추기 위한 가장 적절한 접근법은 무엇인가요?
- SQL Unit 통합 기준 수립
- 동적 SQL 처리 정책 결정
- 중복 제거 우선순위 설정

## 예상 효과

### 수정 후 기대 결과
- **SQL_UNITS**: 63개 → 31개 (명세서와 정확히 일치)
- **SQL 분석 정확도**: 중복 제거로 더 정확한 분석
- **시스템 성능**: 불필요한 중복 데이터 제거로 처리 효율성 향상

### 부가 효과
- MyBatis 동적 쿼리에 대한 더 정확한 이해와 분석
- SQL 의존성 분석의 정밀도 향상
- ERD 생성 시 더 정확한 테이블 관계 도출

---

**생성일시**: 2025-09-05 20:32:00  
**분석자**: SourceAnalyzer Technical Team  
**심각도**: Medium (정확도 개선 관련)  
**예상 수정 시간**: 2-3시간


