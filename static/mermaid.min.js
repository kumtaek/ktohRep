// Mermaid.js ê²½ëŸ‰í™” ë²„ì „ (ì˜¤í”„ë¼ì¸ìš©)
// ì‹¤ì œ ì‚¬ìš©ì‹œì—ëŠ” ì „ì²´ mermaid.js ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ í•„ìš”í•˜ì§€ë§Œ,
// ë°ëª¨ìš©ìœ¼ë¡œ ê°„ë‹¨í•œ SVG ë Œë”ë§ í•¨ìˆ˜ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

window.mermaid = {
    initialize: function(config) {
        console.log('Mermaid initialized with config:', config);
        this.config = config;
    },
    
    render: function(id, definition, callback) {
        // ê°„ë‹¨í•œ í…ìŠ¤íŠ¸ ê¸°ë°˜ ë Œë”ë§ (ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ì „ì²´ mermaid.js í•„ìš”)
        const element = document.getElementById(id);
        if (element) {
            // SVG ì»¨í…Œì´ë„ˆ ìƒì„±
            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute("width", "100%");
            svg.setAttribute("height", "400");
            
            // ê°„ë‹¨í•œ í…ìŠ¤íŠ¸ í‘œì‹œ
            const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
            text.setAttribute("x", "50%");
            text.setAttribute("y", "50%");
            text.setAttribute("text-anchor", "middle");
            text.setAttribute("dominant-baseline", "middle");
            text.setAttribute("fill", "#333");
            text.setAttribute("font-size", "14");
            text.textContent = "ë‹¤ì´ì–´ê·¸ë¨ ì˜ì—­ (ì „ì²´ Mermaid.js ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤)";
            
            svg.appendChild(text);
            element.appendChild(svg);
            
            if (callback) callback(null, svg.outerHTML);
        }
    },
    
    init: function() {
        // í˜ì´ì§€ ë¡œë“œì‹œ ëª¨ë“  .mermaid í´ë˜ìŠ¤ ìš”ì†Œ ì²˜ë¦¬
        document.addEventListener('DOMContentLoaded', () => {
            const elements = document.querySelectorAll('.mermaid');
            elements.forEach((element, index) => {
                const definition = element.textContent.trim();
                element.innerHTML = '';
                
                if (definition.startsWith('graph') || definition.startsWith('flowchart')) {
                    this.renderFlowchart(element, definition);
                } else if (definition.startsWith('erDiagram')) {
                    this.renderERD(element, definition);
                } else {
                    this.renderGeneric(element, definition);
                }
            });
        });
    },
    
    renderFlowchart: function(element, definition) {
        const svg = `
            <svg width="100%" height="300" viewBox="0 0 800 300">
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                            refX="10" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#333" />
                    </marker>
                </defs>
                
                <!-- Controller Layer -->
                <rect x="50" y="20" width="150" height="40" rx="5" fill="#e1f5fe" stroke="#01579b"/>
                <text x="125" y="43" text-anchor="middle" fill="#01579b" font-size="12" font-weight="bold">Controller Layer</text>
                
                <!-- Service Layer -->
                <rect x="300" y="20" width="150" height="40" rx="5" fill="#f3e5f5" stroke="#4a148c"/>
                <text x="375" y="43" text-anchor="middle" fill="#4a148c" font-size="12" font-weight="bold">Service Layer</text>
                
                <!-- Data Layer -->
                <rect x="550" y="20" width="150" height="40" rx="5" fill="#e8f5e8" stroke="#1b5e20"/>
                <text x="625" y="43" text-anchor="middle" fill="#1b5e20" font-size="12" font-weight="bold">Data Layer</text>
                
                <!-- Arrows -->
                <line x1="200" y1="40" x2="300" y2="40" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
                <line x1="450" y1="40" x2="550" y2="40" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
                
                <!-- Components -->
                <rect x="60" y="80" width="130" height="25" rx="3" fill="#fff" stroke="#01579b"/>
                <text x="125" y="95" text-anchor="middle" fill="#333" font-size="10">UserController</text>
                
                <rect x="60" y="110" width="130" height="25" rx="3" fill="#fff" stroke="#01579b"/>
                <text x="125" y="125" text-anchor="middle" fill="#333" font-size="10">ProductController</text>
                
                <rect x="310" y="80" width="130" height="25" rx="3" fill="#fff" stroke="#4a148c"/>
                <text x="375" y="95" text-anchor="middle" fill="#333" font-size="10">UserService</text>
                
                <rect x="310" y="110" width="130" height="25" rx="3" fill="#fff" stroke="#4a148c"/>
                <text x="375" y="125" text-anchor="middle" fill="#333" font-size="10">ProductService</text>
                
                <rect x="560" y="80" width="130" height="25" rx="3" fill="#fff" stroke="#1b5e20"/>
                <text x="625" y="95" text-anchor="middle" fill="#333" font-size="10">UserMapper</text>
                
                <rect x="560" y="110" width="130" height="25" rx="3" fill="#fff" stroke="#1b5e20"/>
                <text x="625" y="125" text-anchor="middle" fill="#333" font-size="10">ProductMapper</text>
            </svg>
        `;
        element.innerHTML = svg;
    },
    
    renderERD: function(element, definition) {
        const svg = `
            <svg width="100%" height="350" viewBox="0 0 900 350">
                <!-- USERS Table -->
                <rect x="50" y="50" width="150" height="120" fill="#fff3e0" stroke="#e65100" stroke-width="2"/>
                <rect x="50" y="50" width="150" height="25" fill="#e65100"/>
                <text x="125" y="67" text-anchor="middle" fill="white" font-weight="bold" font-size="12">USERS</text>
                <text x="60" y="85" fill="#333" font-size="10">ğŸ”‘ id (PK)</text>
                <text x="60" y="100" fill="#333" font-size="10">username</text>
                <text x="60" y="115" fill="#333" font-size="10">email</text>
                <text x="60" y="130" fill="#333" font-size="10">status</text>
                <text x="60" y="145" fill="#333" font-size="10">created_date</text>
                
                <!-- PRODUCTS Table -->
                <rect x="350" y="50" width="150" height="140" fill="#e8f5e8" stroke="#1b5e20" stroke-width="2"/>
                <rect x="350" y="50" width="150" height="25" fill="#1b5e20"/>
                <text x="425" y="67" text-anchor="middle" fill="white" font-weight="bold" font-size="12">PRODUCTS</text>
                <text x="360" y="85" fill="#333" font-size="10">ğŸ”‘ id (PK)</text>
                <text x="360" y="100" fill="#333" font-size="10">product_name</text>
                <text x="360" y="115" fill="#333" font-size="10">price</text>
                <text x="360" y="130" fill="#333" font-size="10">category_id (FK)</text>
                <text x="360" y="145" fill="#333" font-size="10">brand_id (FK)</text>
                <text x="360" y="160" fill="#333" font-size="10">status</text>
                
                <!-- CATEGORIES Table -->
                <rect x="650" y="50" width="150" height="100" fill="#f3e5f5" stroke="#4a148c" stroke-width="2"/>
                <rect x="650" y="50" width="150" height="25" fill="#4a148c"/>
                <text x="725" y="67" text-anchor="middle" fill="white" font-weight="bold" font-size="12">CATEGORIES</text>
                <text x="660" y="85" fill="#333" font-size="10">ğŸ”‘ category_id (PK)</text>
                <text x="660" y="100" fill="#333" font-size="10">category_name</text>
                <text x="660" y="115" fill="#333" font-size="10">description</text>
                <text x="660" y="130" fill="#333" font-size="10">status</text>
                
                <!-- BRANDS Table -->
                <rect x="650" y="200" width="150" height="100" fill="#e1f5fe" stroke="#01579b" stroke-width="2"/>
                <rect x="650" y="200" width="150" height="25" fill="#01579b"/>
                <text x="725" y="217" text-anchor="middle" fill="white" font-weight="bold" font-size="12">BRANDS</text>
                <text x="660" y="235" fill="#333" font-size="10">ğŸ”‘ brand_id (PK)</text>
                <text x="660" y="250" fill="#333" font-size="10">brand_name</text>
                <text x="660" y="265" fill="#333" font-size="10">description</text>
                <text x="660" y="280" fill="#333" font-size="10">status</text>
                
                <!-- Relationships -->
                <defs>
                    <marker id="erd-arrow" markerWidth="8" markerHeight="6" 
                            refX="8" refY="3" orient="auto">
                        <polygon points="0 0, 8 3, 0 6" fill="#666" />
                    </marker>
                </defs>
                
                <!-- Products to Categories -->
                <line x1="500" y1="120" x2="650" y2="100" stroke="#666" stroke-width="2" marker-end="url(#erd-arrow)"/>
                <text x="575" y="105" fill="#666" font-size="10">1:N</text>
                
                <!-- Products to Brands -->
                <line x1="500" y1="160" x2="650" y2="220" stroke="#666" stroke-width="2" marker-end="url(#erd-arrow)"/>
                <text x="575" y="195" fill="#666" font-size="10">1:N</text>
            </svg>
        `;
        element.innerHTML = svg;
    },
    
    renderGeneric: function(element, definition) {
        const svg = `
            <svg width="100%" height="200" viewBox="0 0 600 200">
                <rect x="50" y="50" width="500" height="100" fill="#f8f9fa" stroke="#007acc" stroke-width="2" rx="10"/>
                <text x="300" y="105" text-anchor="middle" fill="#007acc" font-size="16" font-weight="bold">
                    ë‹¤ì´ì–´ê·¸ë¨ ë Œë”ë§ ì˜ì—­
                </text>
                <text x="300" y="125" text-anchor="middle" fill="#666" font-size="12">
                    (ì˜¤í”„ë¼ì¸ í™˜ê²½ì—ì„œëŠ” ë‹¨ìˆœí™”ëœ í‘œì‹œ)
                </text>
            </svg>
        `;
        element.innerHTML = svg;
    }
};

// ìë™ ì´ˆê¸°í™”
window.mermaid.init();