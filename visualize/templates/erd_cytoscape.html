<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Source Analyzer - Cytoscape.js ERD</title>
    
         <!-- jQuery ë¨¼ì € ë¡œë“œ -->
     <script src="./static/js/jquery-3.6.0.min.js"></script>
     
     <!-- Cytoscape.js -->
     <script src="./static/js/cytoscape.min.js"></script>
     
     <!-- ì˜ì¡´ì„± ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤ (í™•ì¥ë“¤ì´ í•„ìš”ë¡œ í•¨) -->
     <script src="./static/js/dagre.min.js"></script>
     <script src="./static/js/layout-base.js"></script>
     
     <!-- Cytoscape.js Layout Extensions -->
     <script src="./static/js/cytoscape-dagre.js"></script>
     <script src="./static/js/cytoscape-fcose.js"></script>
     
     <!-- Cytoscape.js UI Extensions -->
     <!-- cytoscape-qtipì€ í˜„ì¬ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ -->
     <!-- <script src="./static/js/cytoscape-qtip.js"></script> -->
     <script src="./static/js/jquery.qtip.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body, html {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            height: 100vh;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }
        
        .header .project-info {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .toolbar {
            background: white;
            padding: 15px 20px;
            border-bottom: 1px solid #e1e5e9;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .toolbar-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .toolbar-group label {
            font-weight: 500;
            color: #495057;
            font-size: 14px;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        }
        
        .search-box {
            padding: 8px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
            min-width: 250px;
            transition: border-color 0.2s ease;
        }
        
        .search-box:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .stats {
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #6c757d;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .stat-value {
            font-weight: 600;
            color: #495057;
        }
        
        .main-container {
            display: flex;
            height: calc(100vh - 140px);
        }
        
        .sidebar {
            width: 300px;
            background: white;
            border-right: 1px solid #e1e5e9;
            overflow-y: auto;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
        }
        
        .sidebar-section {
            margin-bottom: 25px;
        }
        
        .sidebar-section h3 {
            color: #495057;
            font-size: 16px;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e1e5e9;
        }
        
        .table-list {
            list-style: none;
        }
        
        .table-item {
            padding: 8px 12px;
            margin-bottom: 5px;
            background: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }
        
        .table-item:hover {
            background: #e9ecef;
            border-left-color: #667eea;
        }
        
        .table-item.selected {
            background: #667eea;
            color: white;
        }
        
        .table-item .table-name {
            font-weight: 500;
        }
        
        .table-item .table-owner {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 2px;
        }
        
        .cytoscape-container {
            flex: 1;
            background: #f8f9fa;
            position: relative;
        }
        
        #cy {
            width: 100%;
            height: 100%;
        }
        
        .legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            font-size: 12px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
        }
        
        .legend-text {
            color: #495057;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            text-align: center;
            z-index: 1000;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .tooltip {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 0;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: none;
            z-index: 2000;
            font-size: 12px;
        }
        
        .tooltip-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            border-radius: 8px 8px 0 0;
        }
        
        .tooltip-title {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .tooltip-subtitle {
            font-size: 11px;
            opacity: 0.9;
        }
        
        .tooltip-content {
            padding: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .columns-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }
        
        .column-item {
            padding: 8px 12px;
            border-bottom: 1px solid #f1f3f4;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .column-item:last-child {
            border-bottom: none;
        }
        
        .column-info {
            flex: 1;
        }
        
        .column-name {
            font-weight: 500;
            color: #212529;
        }
        
        .column-type {
            font-size: 11px;
            color: #6c757d;
            font-family: 'Courier New', monospace;
        }
        
        .column-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 500;
        }
        
        .badge-pk {
            background: #28a745;
            color: white;
        }
        
        .badge-fk {
            background: #007bff;
            color: white;
        }
        
        .badge-nullable {
            background: #6c757d;
            color: white;
        }
        
        .badge-not-null {
            background: #dc3545;
            color: white;
        }
        
        .edge-tooltip {
            position: absolute;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 0;
            max-width: 380px;
            min-width: 200px;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
            display: none;
            z-index: 2100;
            font-size: 12px;
            pointer-events: none;
        }
        
        .edge-tooltip-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 12px;
            border-radius: 6px 6px 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 600;
            font-size: 13px;
        }
        
        .edge-tooltip-type {
            font-size: 10px;
            background: rgba(255,255,255,0.2);
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 500;
        }
        
        .edge-tooltip-content {
            color: #495057;
            padding: 12px;
        }
        
        .join-condition {
            background: linear-gradient(135deg, #e8f4fd 0%, #f1f8ff 100%);
            border: 1px solid #b3d9ff;
            padding: 8px 12px;
            border-radius: 6px;
            margin: 8px 0;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            font-weight: 500;
            color: #0056b3;
        }
        
        .responsive-controls {
            display: none;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 250px;
            }
            
            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .toolbar-group {
                justify-content: center;
            }
            
            .responsive-controls {
                display: block;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>ğŸ—ï¸ Source Analyzer ERD</h1>
            <div class="project-info" id="project-info">í”„ë¡œì íŠ¸: ë¡œë”© ì¤‘...</div>
        </div>
        <div class="stats">
            <div class="stat-item">
                ğŸ“Š í…Œì´ë¸”: <span class="stat-value" id="node-count">0</span>
            </div>
            <div class="stat-item">
                ğŸ”— ê´€ê³„: <span class="stat-value" id="edge-count">0</span>
            </div>
        </div>
    </div>
    
    <div class="toolbar">
        <div class="toolbar-group">
            <label>ë ˆì´ì•„ì›ƒ:</label>
                         <button class="btn" onclick="toggleLayout()">
                 <span id="current-layout">dagre</span>
             </button>
        </div>
        
        <div class="toolbar-group">
            <label>ê²€ìƒ‰:</label>
            <input type="text" id="search" class="search-box" placeholder="í…Œì´ë¸”ëª… ë˜ëŠ” ìŠ¤í‚¤ë§ˆëª… ê²€ìƒ‰..." oninput="searchNode(this.value)">
        </div>
        
        <div class="toolbar-group">
            <button class="btn btn-secondary" onclick="resetView()">ğŸ” ì „ì²´ë³´ê¸°</button>
            <button class="btn btn-success" onclick="exportPng()">ğŸ“· PNG ë‚´ë³´ë‚´ê¸°</button>
            <button class="btn btn-warning" onclick="toggleSidebar()">ğŸ“‹ ì‚¬ì´ë“œë°”</button>
        </div>
        
        <div class="responsive-controls">
            <button class="btn btn-secondary" onclick="toggleFullscreen()">â›¶ ì „ì²´í™”ë©´</button>
        </div>
    </div>
    
    <div class="main-container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-section">
                <h3>ğŸ“‹ í…Œì´ë¸” ëª©ë¡</h3>
                <div id="table-list-container">
                    <div class="loading">
                        <div class="spinner"></div>
                        í…Œì´ë¸” ì •ë³´ ë¡œë”© ì¤‘...
                    </div>
                </div>
            </div>
            
            <div class="sidebar-section">
                <h3>ğŸ¯ í•„í„°ë§</h3>
                <div>
                    <label>ìŠ¤í‚¤ë§ˆ:</label>
                    <select id="owner-filter" class="search-box" onchange="filterByOwner()">
                        <option value="">ì „ì²´</option>
                    </select>
                </div>
            </div>
            
            <div class="sidebar-section">
                <h3>ğŸ“Š í†µê³„</h3>
                <div id="stats-details">
                    <div>ì´ í…Œì´ë¸”: <span id="total-tables">0</span></div>
                    <div>PK ì»¬ëŸ¼: <span id="total-pk">0</span></div>
                    <div>FK ê´€ê³„: <span id="total-fk">0</span></div>
                </div>
            </div>
        </div>
        
        <div class="cytoscape-container">
            <div id="cy"></div>
            
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #e3f2fd; border: 2px solid #1976d2;"></div>
                    <span class="legend-text">í…Œì´ë¸”</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #dc3545;"></div>
                    <span class="legend-text">FK ê´€ê³„</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #007bff;"></div>
                    <span class="legend-text">PK-PK ê´€ê³„</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #6c757d;"></div>
                    <span class="legend-text">ì¼ë°˜ ê´€ê³„</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tooltips -->
    <div class="tooltip" id="tooltip">
        <div class="tooltip-header">
            <div class="tooltip-title" id="tooltip-title"></div>
            <div class="tooltip-subtitle" id="tooltip-subtitle"></div>
        </div>
        <div class="tooltip-content">
            <div id="tooltip-content"></div>
        </div>
    </div>
    
    <div class="edge-tooltip" id="edge-tooltip">
        <div class="edge-tooltip-header">
            <span id="edge-tooltip-title">ê´€ê³„ ì •ë³´</span>
            <span class="edge-tooltip-type" id="edge-tooltip-type">FK</span>
        </div>
        <div class="edge-tooltip-content">
            <div id="edge-tooltip-content"></div>
        </div>
    </div>
    
    <script>
        // ì „ì—­ ë³€ìˆ˜
        let cy;
        let currentLayout = 'dagre';
        let layoutOptions = {};
        let tooltip = document.getElementById('tooltip');
        let edgeTooltip = document.getElementById('edge-tooltip');
        let tooltipTimeout;
        let edgeTooltipTimeout;
        let isTooltipVisible = false;
        let isEdgeTooltipVisible = false;
        

        
        // Cytoscape.js ì´ˆê¸°í™”
        function initCytoscape() {
            // ë ˆì´ì•„ì›ƒ ì˜µì…˜ ì„¤ì •
            layoutOptions = {
                'fcose': {
                    name: 'fcose',
                    quality: 'proof',
                    randomize: true,
                    animate: true,
                    animationDuration: 2000,
                    fit: true,
                    padding: 200,
                    nodeSeparation: 500,
                    idealEdgeLength: edge => {
                        const confidence = edge.data('confidence') || 0.5;
                        const kind = edge.data('kind') || '';
                        if (kind === 'foreign_key' || kind === 'fk_inferred') {
                            return Math.max(300, 600 - (confidence * 150));
                        }
                        return Math.max(250, 500 - (confidence * 120));
                    },
                    nodeRepulsion: 25000,
                    edgeElasticity: edge => {
                        const confidence = edge.data('confidence') || 0.5;
                        const kind = edge.data('kind') || '';
                        if (kind === 'foreign_key' || kind === 'fk_inferred') {
                            return confidence * 0.25;
                        }
                        return confidence * 0.2;
                    },
                    gravity: 0.1,
                    gravityRange: 3.8,
                    gravityCompound: 0.3,
                    initialTemp: 200,
                    coolingFactor: 0.95,
                    minTemp: 1.0,
                    numIter: 2500
                },
                'dagre': {
                    name: 'dagre',
                    nodeSep: 150,
                    edgeSep: 50,
                    rankSep: 200,
                    rankDir: 'TB',
                    ranker: 'longest-path',
                    animate: true,
                    fit: true,
                    padding: 100
                }
            };
            
            // Cytoscape ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
            cy = window.cy = cytoscape({
                container: document.getElementById('cy'),
                elements: [],
                layout: layoutOptions[currentLayout],
                
                style: [
                    {
                        selector: 'node',
                        style: {
                            'background-color': '#ffffff',
                            'border-color': data => {
                                const group = data.group;
                                if (group === 'DB') return '#1976d2';
                                return '#6c757d';
                            },
                            'border-width': 2,
                            'label': 'data(label)',
                            'text-wrap': 'wrap',
                            'text-max-width': '180px',
                            'text-valign': 'center',
                            'text-halign': 'center',
                            'font-size': '14px',
                            'font-weight': 'bold',
                            'width': 'mapData(label.length, 5, 50, 100, 200)',
                            'height': data => {
                                const columns = data.meta?.columns || [];
                                const baseHeight = 60;
                                const columnHeight = Math.min(columns.length * 8, 100);
                                return baseHeight + columnHeight;
                            },
                            'shape': 'round-rectangle',
                            'z-index': 1
                        }
                    },
                    {
                        selector: 'node[type="table"]',
                        style: {
                            'background-color': '#e3f2fd',
                            'border-color': '#1976d2'
                        }
                    },
                    {
                        selector: 'node:selected',
                        style: {
                            'border-width': 4,
                            'border-color': '#ff5722',
                            'z-index': 999
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': data => {
                                const confidence = data.confidence || 0.5;
                                return Math.max(1, confidence * 4);
                            },
                            'line-color': data => {
                                const kind = data.kind;
                                if (kind === 'foreign_key') return '#dc3545';
                                if (kind === 'fk_inferred') return '#fd7e14';
                                if (kind === 'pk_to_pk') return '#007bff';
                                if (kind === 'non_pk_relation') return '#6c757d';
                                return '#6c757d';
                            },
                            'target-arrow-color': data => {
                                const kind = data.kind;
                                if (kind === 'foreign_key') return '#dc3545';
                                if (kind === 'fk_inferred') return '#fd7e14';
                                if (kind === 'pk_to_pk') return '#007bff';
                                if (kind === 'non_pk_relation') return '#6c757d';
                                return '#6c757d';
                            },
                            'target-arrow-shape': data => {
                                const kind = data.kind;
                                const meta = data.meta || {};
                                
                                if (meta.arrow === false || kind === 'relationship') {
                                    return 'none';
                                }
                                if (kind === 'non_pk_relation') return 'none';
                                
                                return 'triangle';
                            },
                                                         'target-arrow-size': '10px',
                            'curve-style': 'bezier',
                            'source-endpoint': 'outside-to-node',
                            'target-endpoint': 'outside-to-node',
                            'opacity': data => {
                                const confidence = data.confidence || 0.5;
                                return Math.max(0.3, confidence);
                            }
                        }
                    },
                    {
                        selector: 'edge:selected',
                        style: {
                            'line-color': '#ff5722',
                            'target-arrow-color': '#ff5722',
                            'width': 4,
                            'opacity': 1
                        }
                    }
                ],
                                 
                 minZoom: 0.1,
                 maxZoom: 5,
                 wheelSensitivity: 0.2
            });
            
            // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì„¤ì •
            setupEventHandlers();
            
            // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
            loadData();
        }
        
        // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì„¤ì •
        function setupEventHandlers() {
            // ë…¸ë“œ ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸
            cy.on('mouseover', 'node', function(event) {
                const node = event.target;
                clearTimeout(tooltipTimeout);
                hideEdgeTooltip();
                
                tooltipTimeout = setTimeout(() => {
                    const renderedPosition = event.renderedPosition;
                    showTooltip(node, renderedPosition.x, renderedPosition.y);
                }, 500);
            });
            
            cy.on('mouseout', 'node', function(event) {
                clearTimeout(tooltipTimeout);
                setTimeout(() => {
                    if (!isTooltipVisible) return;
                    hideTooltip();
                }, 100);
            });
            
            // ì—£ì§€ ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸
            cy.on('mouseover', 'edge', function(event) {
                const edge = event.target;
                clearTimeout(edgeTooltipTimeout);
                hideTooltip();
                
                edgeTooltipTimeout = setTimeout(() => {
                    const renderedPosition = event.renderedPosition;
                    showEdgeTooltip(edge, renderedPosition.x, renderedPosition.y);
                }, 300);
            });
            
            cy.on('mouseout', 'edge', function(event) {
                clearTimeout(edgeTooltipTimeout);
                setTimeout(() => {
                    if (!isEdgeTooltipVisible) return;
                    hideEdgeTooltip();
                }, 100);
            });
            
            // ìº”ë²„ìŠ¤ í´ë¦­ ì‹œ íˆ´íŒ ìˆ¨ê¹€
            cy.on('tap', function(event) {
                if (event.target === cy) {
                    hideTooltip();
                    hideEdgeTooltip();
                }
            });
            
            // ë…¸ë“œ ì„ íƒ ì´ë²¤íŠ¸
            cy.on('select', 'node', function(event) {
                const node = event.target;
                highlightRelatedElements(node);
                updateSidebarSelection(node.id());
            });
            
            // ì„ íƒ í•´ì œ ì´ë²¤íŠ¸
            cy.on('unselect', 'node', function(event) {
                cy.elements().style('opacity', 1);
                cy.elements().style('z-index', 1);
            });
        }
        
        // ë°ì´í„° ë¡œë“œ
        function loadData() {
            // ì‹¤ì œ ë°ì´í„°ëŠ” ë Œë”ëŸ¬ì—ì„œ ì£¼ì…ë©ë‹ˆë‹¤
            // DATA ë³€ìˆ˜ê°€ ë Œë”ëŸ¬ì— ì˜í•´ ì •ì˜ë˜ì–´ì•¼ í•¨
            let actualData;
            
            // ë Œë”ëŸ¬ì—ì„œ ì£¼ì…ëœ ë°ì´í„° í™•ì¸
            if (typeof DATA !== 'undefined' && DATA) {
                console.log('âœ… ë Œë”ëŸ¬ì—ì„œ ì£¼ì…ëœ ì‹¤ì œ ë°ì´í„° ì‚¬ìš©');
                actualData = DATA;
            } else {
                console.warn('âš ï¸ ì‹¤ì œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ì„œ ë¹ˆ ë°ì´í„°ë¡œ ì´ˆê¸°í™”');
                actualData = { nodes: [], edges: [] };
            }
            
            // ë°ì´í„° ì ìš©
            applyData(actualData);
            
            // ì‚¬ì´ë“œë°” ì—…ë°ì´íŠ¸
            updateSidebar(actualData);
        }
        
        // ë°ì´í„° ì ìš©
        function applyData(data) {
            const elements = [];
            
            // ë…¸ë“œ ì¶”ê°€
            for (const node of data.nodes || []) {
                elements.push({
                    data: {
                        id: node.id,
                        label: node.label,
                        type: node.type,
                        group: node.group,
                        meta: node.meta
                    }
                });
            }
            
            // ì—£ì§€ ì¶”ê°€
            for (const edge of data.edges || []) {
                elements.push({
                    data: {
                        id: edge.id,
                        source: edge.source,
                        target: edge.target,
                        kind: edge.kind,
                        confidence: edge.confidence,
                        meta: edge.meta
                    }
                });
            }
            
            // Cytoscapeì— ìš”ì†Œ ì¶”ê°€
            cy.add(elements);
            
            // ë ˆì´ì•„ì›ƒ ì ìš©
            cy.layout(layoutOptions[currentLayout]).run();
            
            // í†µê³„ ì—…ë°ì´íŠ¸
            updateStats(data);
        }
        
        // ì‚¬ì´ë“œë°” ì—…ë°ì´íŠ¸
        function updateSidebar(data) {
            const tableListContainer = document.getElementById('table-list-container');
            const ownerFilter = document.getElementById('owner-filter');
            
            // í…Œì´ë¸” ëª©ë¡ ìƒì„±
            let tableListHTML = '';
            const owners = new Set();
            
            for (const node of data.nodes || []) {
                if (node.type === 'table') {
                    const owner = node.meta?.owner || 'UNKNOWN';
                    owners.add(owner);
                    
                    tableListHTML += `
                        <div class="table-item" data-table-id="${node.id}" onclick="selectTable('${node.id}')">
                            <div class="table-name">${node.label}</div>
                            <div class="table-owner">${owner}</div>
                        </div>
                    `;
                }
            }
            
            tableListContainer.innerHTML = tableListHTML;
            
            // ìŠ¤í‚¤ë§ˆ í•„í„° ì˜µì…˜ ìƒì„±
            let ownerOptions = '<option value="">ì „ì²´</option>';
            for (const owner of owners) {
                ownerOptions += `<option value="${owner}">${owner}</option>`;
            }
            ownerFilter.innerHTML = ownerOptions;
        }
        
        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats(data) {
            const nodes = data.nodes || [];
            const edges = data.edges || [];
            
            let totalPk = 0;
            let totalFk = 0;
            
            for (const node of nodes) {
                if (node.meta?.columns) {
                    for (const col of node.meta.columns) {
                        if (col.is_pk) totalPk++;
                    }
                }
            }
            
            for (const edge of edges) {
                if (edge.kind === 'foreign_key') totalFk++;
            }
            
            document.getElementById('node-count').textContent = nodes.length;
            document.getElementById('edge-count').textContent = edges.length;
            document.getElementById('total-tables').textContent = nodes.length;
            document.getElementById('total-pk').textContent = totalPk;
            document.getElementById('total-fk').textContent = totalFk;
        }
        
        // íˆ´íŒ í‘œì‹œ
        function showTooltip(node, x, y) {
            const data = node.data();
            const meta = data.meta || {};
            
            document.getElementById('tooltip-title').textContent = data.label || 'Unknown Table';
            document.getElementById('tooltip-subtitle').textContent = meta.owner ? `Owner: ${meta.owner}` : '';
            
            let contentHTML = '';
            if (meta.columns && meta.columns.length > 0) {
                contentHTML = '<ul class="columns-list">';
                for (const col of meta.columns) {
                    const badges = [];
                    if (col.is_pk) badges.push('<span class="column-badge badge-pk">PK</span>');
                    if (col.nullable) badges.push('<span class="column-badge badge-nullable">NULL</span>');
                    else badges.push('<span class="column-badge badge-not-null">NOT NULL</span>');
                    
                    contentHTML += `
                        <li class="column-item">
                            <div class="column-info">
                                <div class="column-name">${col.name}</div>
                                <div class="column-type">${col.data_type}</div>
                            </div>
                            <div>${badges.join('')}</div>
                        </li>
                    `;
                }
                contentHTML += '</ul>';
            }
            
            document.getElementById('tooltip-content').innerHTML = contentHTML;
            
            tooltip.style.display = 'block';
            tooltip.style.left = (x + 10) + 'px';
            tooltip.style.top = (y - 10) + 'px';
            isTooltipVisible = true;
        }
        
        // íˆ´íŒ ìˆ¨ê¹€
        function hideTooltip() {
            tooltip.style.display = 'none';
            isTooltipVisible = false;
        }
        
        // ì—£ì§€ íˆ´íŒ í‘œì‹œ
        function showEdgeTooltip(edge, x, y) {
            const data = edge.data();
            const meta = data.meta || {};
            
            document.getElementById('edge-tooltip-title').textContent = `${data.source} â†’ ${data.target}`;
            document.getElementById('edge-tooltip-type').textContent = data.kind === 'foreign_key' ? 'FK' : 'REL';
            
            let contentHTML = '';
            if (meta.left_column && meta.right_column) {
                contentHTML += `
                    <div class="join-condition">
                        ${meta.left_column} = ${meta.right_column}
                    </div>
                `;
            }
            
            if (meta.frequency) {
                contentHTML += `<div>ë¹ˆë„: ${meta.frequency}</div>`;
            }
            
            if (meta.confidence) {
                contentHTML += `<div>ì‹ ë¢°ë„: ${(meta.confidence * 100).toFixed(1)}%</div>`;
            }
            
            document.getElementById('edge-tooltip-content').innerHTML = contentHTML;
            
            edgeTooltip.style.display = 'block';
            edgeTooltip.style.left = (x + 10) + 'px';
            edgeTooltip.style.top = (y - 10) + 'px';
            isEdgeTooltipVisible = true;
        }
        
        // ì—£ì§€ íˆ´íŒ ìˆ¨ê¹€
        function hideEdgeTooltip() {
            edgeTooltip.style.display = 'none';
            isEdgeTooltipVisible = false;
        }
        
        // ê´€ë ¨ ìš”ì†Œ í•˜ì´ë¼ì´íŠ¸
        function highlightRelatedElements(node) {
            cy.elements().style('opacity', 0.3);
            node.style('opacity', 1);
            node.connectedEdges().style('opacity', 0.8);
            node.connectedEdges().connectedNodes().style('opacity', 0.6);
        }
        
        // ì‚¬ì´ë“œë°” ì„ íƒ ì—…ë°ì´íŠ¸
        function updateSidebarSelection(tableId) {
            document.querySelectorAll('.table-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            const selectedItem = document.querySelector(`[data-table-id="${tableId}"]`);
            if (selectedItem) {
                selectedItem.classList.add('selected');
            }
        }
        
        // í…Œì´ë¸” ì„ íƒ
        function selectTable(tableId) {
            const node = cy.getElementById(tableId);
            if (node.length > 0) {
                cy.elements().unselect();
                node.select();
                cy.fit(node, 100);
            }
        }
        
        // ìŠ¤í‚¤ë§ˆë³„ í•„í„°ë§
        function filterByOwner() {
            const selectedOwner = document.getElementById('owner-filter').value;
            
            if (!selectedOwner) {
                cy.elements().style('display', 'element');
                return;
            }
            
            cy.nodes().forEach(node => {
                const owner = node.data('meta')?.owner;
                if (owner === selectedOwner) {
                    node.style('display', 'element');
                    node.connectedEdges().style('display', 'element');
                } else {
                    node.style('display', 'none');
                    node.connectedEdges().style('display', 'none');
                }
            });
        }
        
        // ë ˆì´ì•„ì›ƒ ì „í™˜
        function toggleLayout() {
            currentLayout = currentLayout === 'dagre' ? 'fcose' : 'dagre';
            document.getElementById('current-layout').textContent = currentLayout;
            resetView();
        }
        
        // ë·° ë¦¬ì…‹
        function resetView() {
            cy.layout(layoutOptions[currentLayout]).run();
            cy.fit();
        }
        
        // PNG ë‚´ë³´ë‚´ê¸°
        function exportPng() {
            const png = cy.png({
                scale: 2,
                full: true,
                bg: 'white'
            });
            
            const link = document.createElement('a');
            link.download = 'erd-cytoscape.png';
            link.href = png;
            link.click();
        }
        
        // ì‚¬ì´ë“œë°” í† ê¸€
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.style.display = sidebar.style.display === 'none' ? 'block' : 'none';
        }
        
        // ì „ì²´í™”ë©´ í† ê¸€
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
        
        // ë…¸ë“œ ê²€ìƒ‰
        function searchNode(query) {
            cy.elements().removeClass('highlighted');
            
            if (!query.trim()) {
                cy.elements().style('opacity', 1);
                return;
            }
            
            const matchedNodes = cy.nodes().filter(node => {
                const label = node.data('label').toLowerCase();
                const tableName = node.data('meta')?.table_name?.toLowerCase() || '';
                const owner = node.data('meta')?.owner?.toLowerCase() || '';
                
                return label.includes(query.toLowerCase()) || 
                       tableName.includes(query.toLowerCase()) || 
                       owner.includes(query.toLowerCase());
            });
            
            if (matchedNodes.length > 0) {
                cy.elements().style('opacity', 0.3);
                matchedNodes.style('opacity', 1);
                matchedNodes.connectedEdges().style('opacity', 0.8);
                cy.fit(matchedNodes, 100);
            } else {
                cy.elements().style('opacity', 1);
            }
        }
        
                 // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
         document.addEventListener('DOMContentLoaded', function() {
             try {
                 // ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© í™•ì¸
                 if (typeof cytoscape === 'undefined') {
                     throw new Error('Cytoscape.jsê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                 }
                 
                          // í™•ì¥ ë“±ë¡ - ì˜ì¡´ì„± í™•ì¸ í›„ ë“±ë¡
         console.log('í™•ì¥ ë“±ë¡ ì‹œì‘...');
         
         // dagre ì˜ì¡´ì„± í™•ì¸
         if (typeof dagre === 'undefined') {
             console.error('âŒ dagre ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
         } else {
             console.log('âœ… dagre ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì™„ë£Œ');
         }
         
         // layout-base ì˜ì¡´ì„± í™•ì¸  
         if (typeof layoutBase === 'undefined') {
             console.warn('âš ï¸ layout-base ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤ (fcose ì‚¬ìš© ë¶ˆê°€)');
         } else {
             console.log('âœ… layout-base ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì™„ë£Œ');
         }
         
         // cytoscape-dagre í™•ì¥ ë“±ë¡ (dagre ì˜ì¡´ì„± í•„ìš”)
         if (typeof cytoscapeDagre !== 'undefined' && typeof dagre !== 'undefined') {
             cytoscape.use(cytoscapeDagre);
             console.log('âœ… cytoscape-dagre í™•ì¥ ë“±ë¡ ì™„ë£Œ');
         } else {
             console.warn('âŒ cytoscape-dagre í™•ì¥ ë˜ëŠ” dagre ì˜ì¡´ì„±ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
         }
         
         // cytoscape-fcose í™•ì¥ ë“±ë¡ (layout-base ì˜ì¡´ì„± í•„ìš”)
         if (typeof cytoscapeFcose !== 'undefined' && typeof layoutBase !== 'undefined') {
             cytoscape.use(cytoscapeFcose);
             console.log('âœ… cytoscape-fcose í™•ì¥ ë“±ë¡ ì™„ë£Œ');
         } else {
             console.warn('âŒ cytoscape-fcose í™•ì¥ ë˜ëŠ” layout-base ì˜ì¡´ì„±ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
         }
                 
                 // í™•ì¥ ë“±ë¡ í›„ ì´ˆê¸°í™”
                 setTimeout(() => {
                     initCytoscape();
                 }, 100);
                 
             } catch (error) {
                 console.error('ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                 document.getElementById('table-list-container').innerHTML = 
                     '<div style="color: red; padding: 20px; text-align: center;">' +
                     'ERD ë¡œë”© ì‹¤íŒ¨: ' + error.message + '<br>' +
                     'í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê±°ë‚˜ ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.' +
                     '</div>';
             }
         });
        
        // ìœˆë„ìš° ë¦¬ì‚¬ì´ì¦ˆ ì´ë²¤íŠ¸
        window.addEventListener('resize', function() {
            if (cy) {
                cy.resize();
            }
        });
    </script>
</body>
</html>
