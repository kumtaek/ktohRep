<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.dynamic.DynamicMapper">

    <select id="findDynamicData" resultType="map">
        SELECT
        <include refid="selectColumns"/>
        FROM DYNAMIC_TABLE dt
        <where>
            <if test="params.id != null">
                AND dt.ID = #{params.id}
            </if>
            <if test="params.name != null and params.name != ''">
                AND dt.NAME LIKE '%' || #{params.name} || '%'
            </if>
            <choose>
                <when test="params.type == 'A'">
                    AND dt.TYPE = 'TYPE_A'
                </when>
                <when test="params.type == 'B'">
                    AND dt.TYPE = 'TYPE_B'
                </when>
                <otherwise>
                    AND dt.TYPE IN ('TYPE_A', 'TYPE_B', 'TYPE_C')
                </otherwise>
            </choose>
            <if test="params.statuses != null and params.statuses.size > 0">
                AND dt.STATUS IN
                <foreach item="status" collection="params.statuses" open="(" separator="," close=")">
                    #{status}
                </foreach>
            </if>
            AND dt.DEL_YN = 'N' <!-- 필수 필터 -->
        </where>
        ORDER BY dt.CREATED_DATE DESC
    </select>

    <sql id="selectColumns">
        dt.ID, dt.NAME, dt.TYPE, dt.STATUS, dt.CREATED_DATE
    </sql>

    <update id="updateDynamicStatus">
        UPDATE DYNAMIC_TABLE
        <set>
            STATUS = #{status},
            UPDATED_DATE = SYSDATE
        </set>
        <where>
            ID IN
            <foreach item="id" collection="ids" open="(" separator="," close=")">
                #{id}
            </foreach>
            AND DEL_YN = 'N'
        </where>
    </update>
    
    <select id="searchProducts" resultType="string">
        SELECT PRODUCT_NAME
        FROM PRODUCTS p
        <where>
            <if test="criteria.category != null">
                AND p.CATEGORY = #{criteria.category}
            </if>
            <if test="criteria.minPrice != null">
                AND p.PRICE >= #{criteria.minPrice}
            </if>
            <if test="criteria.maxPrice != null">
                AND p.PRICE &lt;= #{criteria.maxPrice}
            </if>
            <if test="criteria.keywords != null and criteria.keywords.size > 0">
                AND (
                <foreach item="keyword" collection="criteria.keywords" open="" separator="OR" close="">
                    p.DESCRIPTION LIKE '%' || #{keyword} || '%'
                </foreach>
                )
            </if>
            AND p.IS_ACTIVE = 'Y'
        </where>
    </select>

</mapper>