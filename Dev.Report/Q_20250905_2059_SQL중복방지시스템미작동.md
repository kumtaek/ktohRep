# Q_20250905_2059_SQL중복방지시스템미작동.md

## 문제 상황

A 답변파일 `A_20250905_2032_SQL과다추출.md`의 개선 방안을 모두 적용했음에도 불구하고 SQL Units가 여전히 103.2% 과다 추출되는 문제가 지속되고 있습니다.

## 전후 배경

### **개선 작업 완료 사항**
1. ✅ MyBatis 파서에 전역 중복 방지 시스템 추가
2. ✅ Enhanced unique_id 생성 함수 구현
3. ✅ 프로젝트 분석 시작 시 전역 캐시 초기화
4. ✅ 클래스 레벨 중복 방지 집합 구현

### **현재 상황**
- **SQL Units**: 63개 (명세서 31개 대비 103.2% 과대)
- **중복 방지**: 전역 캐시 시스템이 작동하지 않음
- **MyBatis XML**: 여전히 중복 추출됨

## 구체적 문제 사례

### **사례 1: UserMapper.xml 중복 추출**
```xml
<!-- 실제 XML (9개 쿼리) -->
<select id="selectUserById" resultType="User">
    SELECT * FROM users WHERE id = #{id}
</select>
<select id="selectUsersByCondition" resultType="User">
    SELECT * FROM users WHERE name LIKE #{name}
</select>
<!-- ... 7개 추가 쿼리 -->
```

**현재 추출 결과**: 16개 SQL Units (77% 과대)
**예상 추출 결과**: 9개 SQL Units (중복 방지 적용 시)

### **사례 2: ProductMapper.xml 중복 추출**
```xml
<!-- 실제 XML (7개 쿼리) -->
<select id="selectProductById" resultType="Product">
    SELECT * FROM products WHERE id = #{id}
</select>
<insert id="insertProduct" parameterType="Product">
    INSERT INTO products (name, price) VALUES (#{name}, #{price})
</insert>
<!-- ... 5개 추가 쿼리 -->
```

**현재 추출 결과**: 18개 SQL Units (100% 과대)
**예상 추출 결과**: 7개 SQL Units (중복 방지 적용 시)

### **사례 3: 전역 중복 방지 시스템**
```python
# 구현된 전역 중복 방지 시스템
class MyBatisParser(BaseParser):
    _global_processed_sql_ids = set()  # 클래스 레벨 집합
    
    def _is_unique_sql_unit(self, sql_unit: Dict[str, Any]) -> bool:
        unique_id = self._generate_enhanced_unique_id(sql_unit)
        if unique_id in MyBatisParser._global_processed_sql_ids:
            return False  # 중복이면 제외
        MyBatisParser._global_processed_sql_ids.add(unique_id)
        return True
```

**현재 작동 결과**: 중복 방지 작동하지 않음
**예상 작동 결과**: 동일한 SQL Unit 중복 제거

## 의심 원인

### **🔴 원인 1: 전역 캐시 초기화 실패**
- `MyBatisParser.reset_global_cache()` 호출이 실제로 작동하지 않을 가능성
- 프로젝트 분석 시작 시 캐시가 초기화되지 않을 가능성

### **🔴 원인 2: Enhanced unique_id 생성 오류**
- `_generate_enhanced_unique_id()` 메서드가 동일한 SQL에 대해 다른 ID를 생성할 가능성
- 파일경로, SQL ID, 정규화된 SQL 내용 조합이 고유하지 않을 가능성

### **🔴 원인 3: 중복 검사 로직 오류**
- `_is_unique_sql_unit()` 메서드가 호출되지 않을 가능성
- 중복 검사 후에도 SQL Unit이 저장될 가능성

### **🔴 원인 4: 파서 인스턴스 문제**
- 각 파일마다 새로운 MyBatis 파서 인스턴스가 생성되어 전역 캐시가 공유되지 않을 가능성
- 클래스 레벨 변수가 인스턴스별로 분리될 가능성

## 핵심 질문

**SQL 중복 방지 시스템을 모두 구현했음에도 불구하고 중복 추출이 지속되는 근본 원인은 무엇인가요?**

1. **전역 캐시 초기화 실패**: `reset_global_cache()` 호출이 실제로 작동하지 않는가?
2. **Enhanced unique_id 생성 오류**: 동일한 SQL에 대해 다른 고유 ID가 생성되는가?
3. **중복 검사 로직 오류**: `_is_unique_sql_unit()` 메서드가 호출되지 않는가?
4. **파서 인스턴스 문제**: 전역 캐시가 인스턴스별로 분리되는가?

## 예상 효과

### **해결 시 기대 결과**
- **SQL_UNITS**: 63개 → 31개 (명세서 일치)
- **UserMapper.xml**: 16개 → 9개 (정상)
- **ProductMapper.xml**: 18개 → 7개 (정상)
- **중복 제거율**: 75% 감소

### **부가 효과**
- MyBatis 동적 쿼리에 대한 더 정확한 분석
- SQL 의존성 분석의 정밀도 향상
- ERD 생성 시 더 정확한 테이블 관계 도출

---

**질의 생성일시**: 2025-09-05 20:59:00  
**질의자**: SourceAnalyzer Technical Team  
**상태**: ✅ A 답변파일 기반 개선 완료, 중복 방지 시스템 확인 필요  
**우선순위**: High (SQL Units 103.2% 과대)  
**예상 해결 시간**: 1시간 (전역 캐시 시스템 디버깅 및 수정)


