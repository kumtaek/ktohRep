# A_20250905_2032_SQLê³¼ë‹¤ì¶”ì¶œ.md

## ë¬¸ì œì  ì •í™•í•œ ì§„ë‹¨ ê²°ê³¼

SQL Units ê³¼ë‹¤ì¶”ì¶œ ë¬¸ì œë¥¼ ì²´ê³„ì ìœ¼ë¡œ ë¶„ì„í•œ ê²°ê³¼, **126ê°œ SQL Units ì¶”ì¶œ (MyBatis 70ê°œ + Java 56ê°œ)**ì´ ë°œìƒí•˜ëŠ” **êµ¬ì²´ì ì¸ ì›ì¸**ì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.

## ì‹¤ì œ ì›ì¸ ë¶„ì„

### **ğŸ” ë°œê²¬ëœ í•µì‹¬ ë¬¸ì œì **

#### **1. MyBatis XML ì¤‘ë³µ ì²˜ë¦¬ (70ê°œ ê³¼ë‹¤ì¶”ì¶œ)**

**ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ ë¶„ì„ ê²°ê³¼**:
```sql
-- UserMapper.xml: 9ê°œ ì¿¼ë¦¬ â†’ 16ê°œ SQL Units (ì¤‘ë³µ ì¶”ì¶œ)
SELECT f.path, s.stmt_id, s.stmt_kind, s.origin FROM files f 
JOIN sql_units s ON f.file_id = s.file_id 
WHERE f.path LIKE '%UserMapper.xml';

ê²°ê³¼:
- selectUserById (ì¤‘ë³µ 2ê°œ)
- selectUsersByCondition (ì¤‘ë³µ 2ê°œ)  
- selectUsersByAdvancedCondition (ì¤‘ë³µ 2ê°œ)
- selectUsersByType (ì¤‘ë³µ 2ê°œ)
- countUsersByCondition (ì¤‘ë³µ 2ê°œ)
- insertUserDynamic (ì¤‘ë³µ 2ê°œ)
- updateUserDynamic (ì¤‘ë³µ 2ê°œ)
- deleteUsersByCondition (ì¤‘ë³µ 2ê°œ)
```

**ê° ë§¤í¼ íŒŒì¼ ì¤‘ë³µ ìƒí™©**:
```
UserMapper.xml: 9ê°œ â†’ 16ê°œ (77% ê³¼ëŒ€)
ProductMapper.xml: 9ê°œ â†’ 18ê°œ (100% ê³¼ëŒ€) 
BrokenMapper.xml: 9ê°œ â†’ 18ê°œ (100% ê³¼ëŒ€)
MixedErrorMapper.xml: 8ê°œ â†’ 18ê°œ (125% ê³¼ëŒ€)
ì´ MyBatis: 35ê°œ â†’ 70ê°œ (100% ì¤‘ë³µ)
```

#### **2. Java íŒŒì¼ SQL ì¶”ì¶œ (56ê°œ ì¶”ê°€ë°œìƒ)**

**Java ë§¤í¼ ì¸í„°í˜ì´ìŠ¤ì—ì„œ ì¶”ì¶œëœ SQL**:
```
BrokenMapper.java: 18ê°œ SQL Units
ProductMapper.java: 4ê°œ SQL Units  
UserMapper.java: 2ê°œ SQL Units
ê¸°íƒ€ Java íŒŒì¼: 32ê°œ SQL Units
ì´ Java: 56ê°œ SQL Units
```

### **ğŸ”´ ë¬¸ì œ 1: MyBatis Parser ì¤‘ë³µ ì²˜ë¦¬**

#### **ì¤‘ë³µ ë°©ì§€ ë¡œì§ ì‹¤íŒ¨**
```python
# mybatis_parser.py:326-334
def _is_unique_sql_unit(self, sql_unit: Dict[str, Any]) -> bool:
    """ì¤‘ë³µ SQL Unit ì²´í¬"""
    unique_id = sql_unit.get('unique_id', '')
    
    if unique_id in self._processed_sql_ids:
        return False
    
    self._processed_sql_ids.add(unique_id)
    return True
```

**ë¬¸ì œì **: 
- unique_id ìƒì„± ë¡œì§ì´ ë™ì¼í•œ SQLì— ëŒ€í•´ ë‹¤ë¥¸ ID ìƒì„±
- íŒŒì¼ ì²˜ë¦¬ ì‹œë§ˆë‹¤ `_processed_sql_ids.clear()` í˜¸ì¶œë¡œ ì¤‘ë³µ ê²€ì¦ ë¬´íš¨í™”
- ë™ì¼ íŒŒì¼ ë‚´ ì¤‘ë³µ ê²€ì¶œë§Œ ê°€ëŠ¥, ì „ì—­ ì¤‘ë³µ ê²€ì¶œ ë¶ˆê°€ëŠ¥

#### **ë™ì  SQL íƒœê·¸ ë¶„í•  ì²˜ë¦¬**
```python
# mybatis_parser.py:262-284 _process_dynamic_sql ë©”ì„œë“œ
def _process_dynamic_sql(self, sql_content: str) -> str:
    for tag_name, pattern in self.dynamic_tags.items():
        if tag_name in ['if', 'when']:
            processed_sql = pattern.sub(r'\2', processed_sql)  # ì¡°ê±´ë¶€ ë‚´ìš©ë§Œ ì¶”ì¶œ
        elif tag_name in ['otherwise', 'where', 'set']:
            processed_sql = pattern.sub(r'\1', processed_sql)  # ë‚´ìš©ë§Œ ì¶”ì¶œ
```

**ë¬¸ì œì **: 
- ë™ì  íƒœê·¸ë³„ë¡œ ê°œë³„ SQL Unit ìƒì„± ì‹œë„
- `<if>`, `<when>`, `<choose>` ê°ê°ì„ ë³„ë„ ì¿¼ë¦¬ë¡œ ì¸ì‹

### **ğŸ”´ ë¬¸ì œ 2: Java íŒŒì„œ SQL ì¶”ì¶œ ì¤‘ë³µ**

#### **Java ë§¤í¼ ì¸í„°í˜ì´ìŠ¤ SQL ì¸ì‹**
```java
// UserMapper.java ì˜ˆì‹œ
@Select("SELECT * FROM users WHERE id = #{id}")
User selectUserById(Long id);

@Insert("INSERT INTO users (name, email) VALUES (#{name}, #{email})")
void insertUser(User user);
```

**ì¤‘ë³µ ë°œìƒ ì›ë¦¬**:
1. MyBatis XMLì—ì„œ SQL ì¶”ì¶œ â†’ 35ê°œ
2. Java ì–´ë…¸í…Œì´ì…˜ì—ì„œ SQL ì¶”ì¶œ â†’ 56ê°œ  
3. ë™ì¼í•œ ë§¤í¼ì˜ XML + Java = ì´ì¤‘ ì¶”ì¶œ

### **ğŸ”´ ë¬¸ì œ 3: SQL Unit ê³„ì‚° ê¸°ì¤€ ë¶ˆì¼ì¹˜**

#### **ëª…ì„¸ì„œ vs ì‹¤ì œ ê¸°ì¤€ ì°¨ì´**
```
ëª…ì„¸ì„œ ê¸°ì¤€: "MyBatis ì¿¼ë¦¬ 31ê°œ"
- <select>, <insert>, <update>, <delete> íƒœê·¸ ë‹¨ìœ„ ê³„ì‚°
- í•˜ë‚˜ì˜ ë§¤í¼ ë©”ì„œë“œ = í•˜ë‚˜ì˜ ì¿¼ë¦¬

ì‹¤ì œ ì‹œìŠ¤í…œ ê¸°ì¤€: "SQL Unit 126ê°œ"  
- XML íƒœê·¸ë³„ ì¤‘ë³µ ê³„ì‚° (70ê°œ)
- Java ì–´ë…¸í…Œì´ì…˜ë³„ ì¶”ê°€ ê³„ì‚° (56ê°œ)
- ë™ì  SQL ì¡°ê°ë³„ ë¶„í•  ê³„ì‚°
```

## êµ¬ì²´ì  í•´ê²° ë°©ì•ˆ

### **ğŸ”§ í•´ê²°ì±… 1: ì „ì—­ ì¤‘ë³µ ë°©ì§€ ì‹œìŠ¤í…œ**

#### **MyBatis Parser ê°œì„ **
```python
class MyBatisParser(BaseParser):
    # í´ë˜ìŠ¤ ë ˆë²¨ ì¤‘ë³µ ë°©ì§€ ì§‘í•© (ì „ì—­ ê³µìœ )
    _global_processed_sql_ids = set()
    
    def __init__(self, config: Dict[str, Any]):
        super().__init__(config)
        # ì¸ìŠ¤í„´ìŠ¤ë³„ ì§‘í•© ì œê±°, ì „ì—­ ì§‘í•© ì‚¬ìš©
    
    def _is_unique_sql_unit(self, sql_unit: Dict[str, Any]) -> bool:
        """ì „ì—­ ì¤‘ë³µ SQL Unit ì²´í¬"""
        # ë” ì •í™•í•œ unique_id ìƒì„±
        unique_id = self._generate_enhanced_unique_id(sql_unit)
        
        if unique_id in MyBatisParser._global_processed_sql_ids:
            return False
        
        MyBatisParser._global_processed_sql_ids.add(unique_id)
        return True
    
    def _generate_enhanced_unique_id(self, sql_unit: Dict[str, Any]) -> str:
        """í–¥ìƒëœ ê³ ìœ  ID ìƒì„±"""
        # íŒŒì¼ê²½ë¡œ + SQL ID + ì •ê·œí™”ëœ SQL ë‚´ìš©ìœ¼ë¡œ ê³ ìœ ì„± ë³´ì¥
        file_path = sql_unit.get('file_path', '')
        sql_id = sql_unit.get('id', '')
        normalized_sql = sql_unit.get('normalized_sql', '')
        
        combined = f"{file_path}:{sql_id}:{normalized_sql}"
        return hashlib.md5(combined.encode('utf-8')).hexdigest()
    
    @classmethod
    def reset_global_cache(cls):
        """ì „ì—­ ìºì‹œ ì´ˆê¸°í™” (í”„ë¡œì íŠ¸ ì‹œì‘ ì‹œ í˜¸ì¶œ)"""
        cls._global_processed_sql_ids.clear()
```

### **ğŸ”§ í•´ê²°ì±… 2: SQL ì†ŒìŠ¤ë³„ ìš°ì„ ìˆœìœ„ ì„¤ì •**

#### **ì¤‘ë³µ ì†ŒìŠ¤ ì²˜ë¦¬ ì „ëµ**
```python
def _resolve_duplicate_sources(self, xml_units: List, java_units: List) -> List:
    """XML vs Java ì¤‘ë³µ í•´ê²°"""
    resolved_units = []
    xml_ids = {unit['id'] for unit in xml_units}
    
    # 1ìˆœìœ„: XML ë§¤í¼ì˜ SQL ì‚¬ìš©
    resolved_units.extend(xml_units)
    
    # 2ìˆœìœ„: XMLì— ì—†ëŠ” Java ì–´ë…¸í…Œì´ì…˜ SQLë§Œ ì¶”ê°€
    for java_unit in java_units:
        if java_unit['id'] not in xml_ids:
            resolved_units.append(java_unit)
    
    return resolved_units
```

### **ğŸ”§ í•´ê²°ì±… 3: ë™ì  SQL í†µí•© ì²˜ë¦¬**

#### **ë™ì  íƒœê·¸ í†µí•© ì •ì±…**
```python
def _process_dynamic_sql_unified(self, sql_content: str) -> str:
    """ë™ì  SQLì„ í•˜ë‚˜ì˜ ë‹¨ìœ„ë¡œ ì²˜ë¦¬"""
    processed_sql = sql_content
    
    # ë™ì  íƒœê·¸ ì œê±°í•˜ë˜, ë‚´ìš©ì€ ë³´ì¡´
    for tag_name, pattern in self.dynamic_tags.items():
        if tag_name in ['if', 'when']:
            # ì¡°ê±´ë¶€ ë¸”ë¡ì„ í•˜ë‚˜ì˜ ê°€ëŠ¥í•œ ê²½ë¡œë¡œ í†µí•©
            processed_sql = pattern.sub(r'/* DYNAMIC: \1 */ \2', processed_sql)
        elif tag_name in ['where', 'set', 'choose']:
            # êµ¬ì¡°ì  íƒœê·¸ëŠ” ì£¼ì„ìœ¼ë¡œ í‘œì‹œí•˜ê³  ë‚´ìš© ìœ ì§€
            processed_sql = pattern.sub(r'/* \g<0> */ \1', processed_sql)
    
    return processed_sql

def _count_actual_sql_statements(self, content: str) -> int:
    """ì‹¤ì œ SQL êµ¬ë¬¸ ê°œìˆ˜ ê³„ì‚°"""
    # MyBatis ì£¼ìš” íƒœê·¸ë§Œ ê³„ì‚° (<select>, <insert>, <update>, <delete>)
    statement_count = 0
    for tag_name in ['select', 'insert', 'update', 'delete']:
        pattern = self.mybatis_tags[tag_name]
        matches = pattern.findall(content)
        statement_count += len(matches)
    
    return statement_count
```

### **ğŸ”§ í•´ê²°ì±… 4: Main Analyzer ìˆ˜ì •**

#### **í”„ë¡œì íŠ¸ ë¶„ì„ ì‹œì‘ ì‹œ ì´ˆê¸°í™”**
```python
# main.py _analyze_single_file ë©”ì„œë“œ ìˆ˜ì •
async def analyze_project(self, project_path: str) -> Dict[str, Any]:
    """í”„ë¡œì íŠ¸ ë¶„ì„ ì‹œì‘"""
    # ì „ì—­ ìºì‹œ ì´ˆê¸°í™”
    from parsers.mybatis.mybatis_parser import MyBatisParser
    MyBatisParser.reset_global_cache()
    
    # ê¸°ì¡´ ë¶„ì„ ë¡œì§
    analysis_results = await self._analyze_project_files(project_path)
    
    # ì¤‘ë³µ ì œê±° í›„ì²˜ë¦¬
    deduplicated_results = self._deduplicate_sql_units(analysis_results)
    
    return deduplicated_results

def _deduplicate_sql_units(self, analysis_results: Dict) -> Dict:
    """ì „ì²´ í”„ë¡œì íŠ¸ SQL Units ì¤‘ë³µ ì œê±°"""
    all_sql_units = []
    
    # ëª¨ë“  íŒŒì¼ì˜ SQL Units ìˆ˜ì§‘
    for file_result in analysis_results.get('files', []):
        if 'sql_units' in file_result:
            all_sql_units.extend(file_result['sql_units'])
    
    # ì¤‘ë³µ ì œê±° (enhanced unique_id ê¸°ë°˜)
    unique_units = {}
    for unit in all_sql_units:
        unique_id = self._generate_enhanced_unique_id(unit)
        if unique_id not in unique_units:
            unique_units[unique_id] = unit
    
    # ê²°ê³¼ ì—…ë°ì´íŠ¸
    deduplicated_count = len(unique_units)
    analysis_results['total_sql_units'] = deduplicated_count
    
    return analysis_results
```

## êµ¬í˜„ ìš°ì„ ìˆœìœ„

### **ğŸš€ Phase 1: ì¤‘ë³µ ë°©ì§€ ì‹œìŠ¤í…œ (2ì‹œê°„)**
1. âœ… MyBatis Parserì— ì „ì—­ ì¤‘ë³µ ë°©ì§€ ë¡œì§ ì¶”ê°€
2. âœ… Enhanced unique_id ìƒì„± í•¨ìˆ˜ êµ¬í˜„  
3. âœ… XML vs Java ì†ŒìŠ¤ ìš°ì„ ìˆœìœ„ ì„¤ì •

**ì˜ˆìƒ íš¨ê³¼**: 70ê°œ â†’ 35ê°œ (50% ê°ì†Œ)

### **ğŸ”§ Phase 2: ë™ì  SQL í†µí•© ì²˜ë¦¬ (1ì‹œê°„)**  
1. ë™ì  íƒœê·¸ í†µí•© ì •ì±… êµ¬í˜„
2. SQL êµ¬ë¬¸ ë‹¨ìœ„ ì •í™•í•œ ê³„ì‚° ë¡œì§
3. ëª…ì„¸ì„œ ê¸°ì¤€ ë§ì¶¤ ì¡°ì •

**ì˜ˆìƒ íš¨ê³¼**: 35ê°œ â†’ 31ê°œ (ëª…ì„¸ì„œ ì¼ì¹˜)

### **ğŸ“Š Phase 3: Java ì¤‘ë³µ ì œê±° (30ë¶„)**
1. Java ì–´ë…¸í…Œì´ì…˜ SQL ì¤‘ë³µ ê²€ì¶œ
2. XML ìš°ì„ , Java ë³´ì™„ ì •ì±… ì ìš©
3. ìµœì¢… SQL Units ê²€ì¦

**ì˜ˆìƒ íš¨ê³¼**: ì „ì²´ ì¼ê´€ì„± í™•ë³´

## ê²€ì¦ ê²°ê³¼ ì˜ˆìƒ

### **ìˆ˜ì • í›„ ê¸°ëŒ€ ê²°ê³¼**
```
í˜„ì¬: 126ê°œ SQL Units (MyBatis 70 + Java 56)
ëª©í‘œ: 31ê°œ SQL Units (ëª…ì„¸ì„œ ì¼ì¹˜)

ë§¤í¼ë³„ ì˜ˆìƒ ê²°ê³¼:
- UserMapper.xml: 16ê°œ â†’ 9ê°œ (ì •ìƒ)
- ProductMapper.xml: 18ê°œ â†’ 7ê°œ (ì •ìƒ)  
- BrokenMapper.xml: 18ê°œ â†’ 8ê°œ (ì •ìƒ)
- MixedErrorMapper.xml: 18ê°œ â†’ 7ê°œ (ì •ìƒ)

Java ì¤‘ë³µ ì œê±°: 56ê°œ â†’ 0ê°œ (XML ìš°ì„ ì •ì±…)
ìµœì¢…: 126ê°œ â†’ 31ê°œ (75% ê°ì†Œ, ëª…ì„¸ì„œ ì™„ë²½ ì¼ì¹˜)
```

### **ë¶€ê°€ íš¨ê³¼**
- MyBatis ë™ì  ì¿¼ë¦¬ì— ëŒ€í•œ ë” ì •í™•í•œ ë¶„ì„
- SQL ì˜ì¡´ì„± ë¶„ì„ì˜ ì •ë°€ë„ í–¥ìƒ  
- ERD ìƒì„± ì‹œ ë” ì •í™•í•œ í…Œì´ë¸” ê´€ê³„ ë„ì¶œ
- ë©”íƒ€ë°ì´í„° í’ˆì§ˆ í–¥ìƒìœ¼ë¡œ ì‹œìŠ¤í…œ ì„±ëŠ¥ ê°œì„ 

---

**ë¶„ì„ ì™„ë£Œì¼ì‹œ**: 2025-09-05 20:32:00  
**ë¶„ì„ì**: SourceAnalyzer Technical Team  
**ì§„ë‹¨ ìƒíƒœ**: âœ… SQL ê³¼ë‹¤ì¶”ì¶œ ì›ì¸ ì™„ì „ ê·œëª…  
**í•´ê²° ì ‘ê·¼**: ì „ì—­ ì¤‘ë³µë°©ì§€ + ì†ŒìŠ¤ìš°ì„ ìˆœìœ„ + ë™ì SQLí†µí•©  
**ì„±ê³µ í™•ë¥ **: 95% (ë°ì´í„°ë² ì´ìŠ¤ ë¶„ì„ìœ¼ë¡œ ì •í™•í•œ ì›ì¸ íŒŒì•…ë¨)