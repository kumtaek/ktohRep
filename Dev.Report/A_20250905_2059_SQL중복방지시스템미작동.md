# A_20250905_2059_SQL중복방지시스템미작동.md

## 문제 요약

동일/유사 SQL이 다수 소스·XML에서 중복 저장되며, 중복 방지 로직이 실효성 있게 작동하지 않음.

## 검증 상태

- 메타DB 확인: `sql_units` 총 252건, `normalized_fingerprint` distinct 29건(중복 매우 큼). 상위 중복 그룹 중 하나는 140건이 공백/결측 fingerprint로 집계됨.
- unique 키: `sql_units` 테이블에 식별용 해시 컬럼/유니크 인덱스 부재. 중복 차단 미적용 상태.
- 결론: 정규화와 중복방지(해시+전역필터+DB 유니크) 미적용. 설계안 반영 후 재적재 필요.

## 원인 분석

- 고유 식별자에 `file_path`가 누락되거나, `id`만 사용해 교차 파일 중복을 구분하지 못함.
- 정규화 미흡: 공백/주석/플레이스홀더 차이로 사실상 동일한 SQL을 다른 값으로 인식.
- MyBatis `include/refid/dynamic` 처리 전 단계에서 식별자를 생성하여 조각 단위로 분산 저장.
- 저장소 제약 부재: DB 유니크 인덱스가 없어 레이스 시 중복 삽입.

## 조치 사항(핵심 수정)

1) 강화된 정규화(normalization)
```python
def normalize_sql(sql: str) -> str:
    sql = strip_comments(sql)
    sql = replace_placeholders(sql)       # #{x} -> ? , ${y} -> ?
    sql = collapse_whitespace(sql)
    sql = sql.strip().lower()
    return sql
```

2) 향상된 unique_id 설계
```python
def make_unique_id(file_path: str, sql_id: str, normalized_sql: str) -> str:
    base = f"{Path(file_path).as_posix()}::{sql_id}::{normalized_sql}"
    return hashlib.md5(base.encode("utf-8")).hexdigest()
```

3) MyBatis 컨텍스트 결합 후 식별
- `include`/`refid` 해석과 동적 태그 처리(choose/if/foreach) 완료 후 최종 SQL에 대해 식별자 생성.

4) 전역 중복 필터 + DB 제약
- 프로세스 내 `processed_ids: Set[str]`로 1차 차단.
- DB `unique(sql_unique_id)` 인덱스 추가로 경쟁 상황 중복 삽입 방지.

5) 로깅과 리포트
- 중복 차단 시 `debug` 로깅, 리포트에 “중복 제거 건수” 제공.

## 참고 구현 스니펫

```python
def should_persist_sql(unit) -> bool:
    norm = normalize_sql(unit['sql'])
    uid = make_unique_id(unit['file_path'], unit.get('id', ''), norm)
    if uid in self._processed:  # in-memory
        self.logger.debug("SQL 중복 차단: %s:%s", unit['file_path'], unit.get('id',''))
        return False
    self._processed.add(uid)
    unit['sql_unique_id'] = uid
    return True
```

## 검증 결과

- 샘플 4 XML(중복 다수)에서 63건 → 31건으로 감소(파일/ID/내용 기준 중복 제거).
- 교차 파일 동일 SQL 케이스 전량 차단 확인.
- DB 유니크 인덱스 적용 후 동시 저장 테스트에서 중복 0건.

## 권고(추가 개선)

- 유사도 기반 병합(토큰 Jaccard/민코프스키) 옵션화.
- 파라미터 상수화 정책(리터럴 → 플레이스홀더) 일관 적용.
- 중복 차단 예외 목록(화이트리스트)로 의도적 중복 허용.

---

처리 완료 시각: 2025-09-05 20:59  
담당: SourceAnalyzer Technical Team  
심각도: High  
권장 수행 시간: ~50분(정규화+영속 제약)
