<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.recommendation.ProductMapper">
    <!--
      Dynamic product query that matches a list of tags. The query uses a nested
      <foreach> to generate OR conditions within an EXISTS clause. This pattern
      results in SQL resembling:

        SELECT p.* FROM T_PRODUCT p
        WHERE EXISTS (
          SELECT 1 FROM T_PRODUCT_TAG t
          WHERE t.product_id = p.id AND (t.tag = ? OR t.tag = ? ...)
        )

      When no tags are provided the EXISTS clause is omitted.
    -->
    <select id="findByTags" parameterType="map" resultType="com.example.recommendation.Product">
        SELECT p.id, p.name
        FROM T_PRODUCT p
        <where>
            <if test="params.tags != null and params.tags.size > 0">
                AND EXISTS (
                    SELECT 1 FROM T_PRODUCT_TAG t
                    WHERE t.product_id = p.id
                    <foreach item="tag" collection="params.tags" separator=" OR ">
                        AND t.tag = #{tag}
                    </foreach>
                )
            </if>
        </where>
    </select>
</mapper>